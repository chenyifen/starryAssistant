# 韩语唤醒词"하이넛지"制作与集成指南

## 概述

本指南详细说明如何为Dicio应用制作和集成韩语唤醒词"하이넛지"（Hi Nutji）。

## 1. OpenWakeWord 自定义唤醒词机制

### 1.1 工作原理

OpenWakeWord使用三个TensorFlow Lite模型：
- **melspectrogram.tflite**: 音频特征提取（通用）
- **embedding.tflite**: 语义嵌入（通用）
- **wake.tflite**: 唤醒词检测（特定唤醒词）

对于自定义唤醒词，只需要替换第三个模型文件。

### 1.2 文件位置

```
/data/data/org.stypox.dicio.master/files/openWakeWord/
├── melspectrogram.tflite    # 通用模型
├── embedding.tflite         # 通用模型  
├── wake.tflite             # 默认"Hey Dicio"模型
└── userwake.tflite         # 自定义唤醒词模型（优先使用）
```

## 2. 韩语唤醒词训练方法

### 2.1 使用OpenWakeWord官方训练工具

#### 准备环境
```bash
# 克隆OpenWakeWord仓库
git clone https://github.com/dscripka/openWakeWord.git
cd openWakeWord

# 安装依赖
pip install -r requirements.txt
pip install openwakeword
```

#### 收集训练数据
```bash
# 创建数据目录
mkdir -p training_data/hi_nutji_korean/{positive,negative}

# 录制正样本（说"하이넛지"的音频）
# 需要至少100-200个不同的录音样本
# 格式：16kHz, 16-bit, mono WAV
```

#### 数据收集建议
1. **正样本（Positive Samples）**：
   - 录制100-200个"하이넛지"的音频
   - 不同的说话者（男女老少）
   - 不同的语调和语速
   - 不同的环境噪音条件

2. **负样本（Negative Samples）**：
   - 其他韩语词汇和句子
   - 环境噪音
   - 音乐和其他声音
   - 类似发音的词汇

#### 训练模型
```bash
# 使用OpenWakeWord训练脚本
python -m openwakeword.train \
    --positive_data_dir training_data/hi_nutji_korean/positive \
    --negative_data_dir training_data/hi_nutji_korean/negative \
    --output_dir models/hi_nutji_korean \
    --model_name hi_nutji_korean \
    --epochs 100
```

### 2.2 使用预训练模型微调

如果有现有的韩语语音识别模型，可以进行迁移学习：

```python
import tensorflow as tf
from openwakeword import Model

# 加载预训练模型
base_model = Model.load_model("path/to/korean_base_model")

# 微调训练
model = base_model.fine_tune(
    positive_samples="training_data/hi_nutji_korean/positive",
    negative_samples="training_data/hi_nutji_korean/negative",
    epochs=50
)

# 保存模型
model.save("hi_nutji_korean.tflite")
```

## 3. 集成到Dicio应用

### 3.1 创建韩语唤醒词管理工具

我已经为您创建了 `KoreanWakeWordManager.kt`：

```kotlin
// 文件位置：app/src/main/kotlin/org/stypox/dicio/util/KoreanWakeWordManager.kt
```

### 3.2 预打包模型到应用

将训练好的模型文件放入assets：

```
app/src/main/assets/models/openWakeWord/
└── hi_nutji_korean.tflite
```

### 3.3 修改AssetModelManager

更新 `AssetModelManager.kt` 以支持韩语唤醒词：

```kotlin
fun hasKoreanWakeWordInAssets(context: Context): Boolean {
    return try {
        context.assets.open("models/openWakeWord/hi_nutji_korean.tflite").use { true }
    } catch (e: Exception) {
        false
    }
}

fun copyKoreanWakeWordModel(context: Context): Boolean {
    return try {
        val userWakeFile = File(context.filesDir, "openWakeWord/userwake.tflite")
        userWakeFile.parentFile?.mkdirs()
        
        context.assets.open("models/openWakeWord/hi_nutji_korean.tflite").use { input ->
            userWakeFile.outputStream().use { output ->
                input.copyTo(output)
            }
        }
        true
    } catch (e: Exception) {
        false
    }
}
```

## 4. UI集成

### 4.1 添加唤醒词切换功能

在设置页面添加唤醒词选择：

```kotlin
@Composable
fun WakeWordSelector(
    currentWakeWord: WakeWordInfo,
    onWakeWordChange: (WakeWordType) -> Unit
) {
    Column {
        Text("选择唤醒词")
        
        RadioButton(
            selected = !currentWakeWord.isCustom,
            onClick = { onWakeWordChange(WakeWordType.DEFAULT) }
        )
        Text("Hey Dicio (English)")
        
        RadioButton(
            selected = currentWakeWord.isCustom && currentWakeWord.language == "Korean",
            onClick = { onWakeWordChange(WakeWordType.KOREAN) }
        )
        Text("하이넛지 (Korean)")
    }
}
```

### 4.2 添加模型管理功能

```kotlin
@Composable
fun WakeWordManagement() {
    var wakeWordInfo by remember { mutableStateOf<WakeWordInfo?>(null) }
    
    LaunchedEffect(Unit) {
        wakeWordInfo = KoreanWakeWordManager.getCurrentWakeWordInfo(context)
    }
    
    Column {
        Text("当前唤醒词: ${wakeWordInfo?.name}")
        
        Button(onClick = {
            // 安装韩语唤醒词
            scope.launch {
                KoreanWakeWordManager.installKoreanWakeWord(context)
            }
        }) {
            Text("安装韩语唤醒词")
        }
        
        Button(onClick = {
            // 恢复默认唤醒词
            scope.launch {
                KoreanWakeWordManager.removeKoreanWakeWord(context)
            }
        }) {
            Text("恢复默认唤醒词")
        }
    }
}
```

## 5. 测试和验证

### 5.1 模型验证

```kotlin
// 验证模型文件
val validation = KoreanWakeWordManager.validateKoreanWakeWordModel(context)
if (validation.isValid) {
    Log.d(TAG, "Korean wake word model is valid")
} else {
    Log.e(TAG, "Invalid model: ${validation.message}")
}
```

### 5.2 性能测试

使用现有的调试系统测试韩语唤醒词：

```kotlin
// 在OpenWakeWordDevice中会自动记录
DebugLogger.logWakeWordDetection(TAG, confidence, threshold, detected)

// 保存音频数据进行分析
AudioDebugSaver.saveWakeAudio(context, audioData, amplitude, confidence)
```

## 6. 部署步骤

### 6.1 准备模型文件

1. **训练韩语唤醒词模型**
2. **验证模型性能**
3. **将模型文件放入assets目录**

### 6.2 更新应用代码

1. **创建KoreanWakeWordManager.kt**
2. **更新AssetModelManager.kt**
3. **添加UI控制组件**
4. **更新设置页面**

### 6.3 测试流程

1. **编译应用**
2. **安装到测试设备**
3. **切换到韩语唤醒词**
4. **测试检测性能**
5. **使用调试工具分析**

## 7. 故障排除

### 7.1 常见问题

1. **模型不加载**
   - 检查文件路径和权限
   - 验证TensorFlow Lite格式
   - 查看错误日志

2. **检测率低**
   - 增加训练数据
   - 调整检测阈值
   - 改善录音质量

3. **误触发高**
   - 增加负样本训练
   - 提高检测阈值
   - 优化模型参数

### 7.2 调试工具

使用现有的调试系统：

```bash
# 查看唤醒检测日志
adb logcat | grep "🎯\[OpenWakeWordDevice\]"

# 拉取音频数据分析
./scripts/pull_audio_debug.sh

# 查看模型加载日志
adb logcat | grep "📦\[KoreanWakeWordManager\]"
```

## 8. 性能优化

### 8.1 模型优化

- **量化**: 使用TensorFlow Lite量化减少模型大小
- **剪枝**: 移除不必要的模型参数
- **压缩**: 使用模型压缩技术

### 8.2 运行时优化

- **缓存**: 缓存模型加载结果
- **预加载**: 应用启动时预加载模型
- **内存管理**: 及时释放不用的资源

## 9. 未来扩展

### 9.1 多语言支持

可以扩展支持更多语言的唤醒词：
- 中文："你好小助手"
- 日语："こんにちは"
- 西班牙语："Hola Dicio"

### 9.2 个性化训练

- 用户自定义录音训练
- 在线学习和适应
- 个人语音特征优化

## 结论

通过本指南，您可以成功制作和集成韩语唤醒词"하이넛지"到Dicio应用中。关键步骤包括训练自定义模型、集成管理工具、更新UI界面和充分测试验证。