# Dicio 技能系统详解

## 技能系统概述

Dicio 的技能系统是整个语音助手的核心，采用插件化架构设计，支持动态加载和管理各种功能技能。每个技能都是独立的模块，负责处理特定类型的用户请求。

## 技能架构设计

### 1. 核心组件

```kotlin
// 技能处理流水线
SkillHandler -> SkillRanker -> SkillEvaluator -> Individual Skills
```

#### SkillHandler
- **职责**: 管理所有可用技能，处理技能的启用/禁用
- **位置**: `app/src/main/kotlin/org/stypox/dicio/eval/SkillHandler.kt`
- **功能**:
  - 维护技能列表和回退技能
  - 根据用户设置过滤启用的技能
  - 构建技能实例

#### SkillRanker
- **职责**: 对用户输入进行技能匹配和评分排序
- **功能**:
  - 计算每个技能对输入的匹配分数
  - 按分数和特异性排序技能
  - 选择最佳匹配技能

#### SkillEvaluator
- **职责**: 执行技能评估和输出生成
- **位置**: `app/src/main/kotlin/org/stypox/dicio/eval/SkillEvaluator.kt`
- **功能**:
  - 处理语音输入事件
  - 管理交互日志
  - 权限请求处理

### 2. 技能基类架构

```kotlin
// 技能继承层次
Skill<InputType>
├── StandardRecognizerSkill<InputType>  // 标准识别技能
└── RecognizeEverythingSkill           // 通用识别技能
    └── RecognizeYesNoSkill           // 是/否识别技能
```

## 已实现技能列表

### 1. 核心技能

#### 天气技能 (WeatherSkill)
- **文件**: `app/src/main/kotlin/org/stypox/dicio/skills/weather/`
- **功能**: 查询天气信息
- **示例**: "今天天气怎么样？", "北京的天气"
- **特性**: 支持地点识别，在线API调用

#### 搜索技能 (SearchSkill)
- **文件**: `app/src/main/kotlin/org/stypox/dicio/skills/search/`
- **功能**: 网络搜索
- **示例**: "搜索人工智能", "查找最新新闻"
- **特性**: 调用默认浏览器进行搜索

#### 计算器技能 (CalculatorSkill)
- **文件**: `app/src/main/kotlin/org/stypox/dicio/skills/calculator/`
- **功能**: 数学计算
- **示例**: "计算 2 + 3", "5 乘以 8 等于多少"
- **特性**: 使用 exp4j 库进行表达式计算

#### 定时器技能 (TimerSkill)
- **文件**: `app/src/main/kotlin/org/stypox/dicio/skills/timer/`
- **功能**: 设置和管理定时器
- **示例**: "设置5分钟定时器", "取消定时器"
- **特性**: 支持命名定时器，铃声提醒

### 2. 系统技能

#### 时间技能 (CurrentTimeSkill)
- **功能**: 查询当前时间
- **示例**: "现在几点了？", "今天是几号？"

#### 导航技能 (NavigationSkill)
- **功能**: 地图导航
- **示例**: "导航到北京", "去最近的加油站"
- **特性**: 调用地图应用

#### 电话技能 (TelephoneSkill)
- **功能**: 拨打电话
- **示例**: "打电话给张三", "拨打10086"
- **权限**: 需要通讯录和拨号权限

#### 媒体控制技能 (MediaSkill)
- **功能**: 控制音乐播放
- **示例**: "播放音乐", "暂停", "下一首"

#### 应用启动技能 (OpenSkill)
- **功能**: 启动应用程序
- **示例**: "打开微信", "启动相机"

#### 歌词技能 (LyricsSkill)
- **功能**: 搜索歌词
- **示例**: "查找歌词 告白气球"

#### 监听控制技能 (ListeningSkill)
- **功能**: 控制语音唤醒
- **示例**: "开始监听", "停止监听"

### 3. 回退技能

#### 文本回退技能 (TextFallbackSkill)
- **功能**: 当没有技能匹配时的默认处理
- **特性**: 显示无法理解的提示信息

## 技能实现详解

### 1. 标准技能实现

```kotlin
class WeatherSkill(
    correspondingSkillInfo: SkillInfo, 
    data: StandardRecognizerData<Weather>
) : StandardRecognizerSkill<Weather>(correspondingSkillInfo, data) {
    
    override suspend fun generateOutput(
        ctx: SkillContext, 
        inputData: Weather
    ): SkillOutput {
        return when (inputData) {
            is Weather.Current -> handleCurrentWeather(inputData)
            is Weather.Forecast -> handleForecast(inputData)
        }
    }
}
```

### 2. 技能信息定义

```kotlin
object WeatherInfo : SkillInfo("weather") {
    override fun name(context: Context) = 
        context.getString(R.string.skill_name_weather)
    
    override fun sentenceExample(context: Context) = 
        context.getString(R.string.skill_sentence_example_weather)
    
    @Composable
    override fun icon() = rememberVectorPainter(Icons.Default.Cloud)
    
    override fun isAvailable(ctx: SkillContext): Boolean {
        return Sentences.Weather[ctx.sentencesLanguage] != null
    }
    
    override fun build(ctx: SkillContext): Skill<*> {
        return WeatherSkill(WeatherInfo, Sentences.Weather[ctx.sentencesLanguage]!!)
    }
}
```

### 3. 句式定义系统

#### 技能定义文件
**位置**: `app/src/main/sentences/skill_definitions.yml`

```yaml
- id: weather
  specificity: high
  sentences:
    - id: current
      captures:
        - id: where
          type: string
    - id: forecast
      captures:
        - id: where
          type: string
        - id: when
          type: string
```

#### 语言句式文件
**位置**: `app/src/main/sentences/en/weather.yml`

```yaml
current:
  - (what is|what's) the weather like? (in|at .where.)?
  - weather (in|at .where.)?
  - how is it outside?

forecast:
  - weather forecast (for .when.)? (in|at .where.)?
  - what will the weather be like .when.? (in|at .where.)?
```

## 技能评分机制

### 1. 评分算法
- **完全匹配**: 1.0 分
- **部分匹配**: 0.0-1.0 分（基于匹配程度）
- **无匹配**: 0.0 分

### 2. 特异性优先级
```kotlin
enum class Specificity {
    LOW,    // 通用技能，如搜索
    MEDIUM, // 中等特异性
    HIGH    // 高特异性，如天气、计算器
}
```

### 3. 技能选择逻辑
1. 计算所有技能的匹配分数
2. 过滤分数 > 0.7 的技能
3. 按特异性和分数排序
4. 选择最高分技能执行

## 技能输出系统

### 1. 输出类型

```kotlin
sealed class SkillOutput {
    // 文本输出
    data class TextOutput(val text: String) : SkillOutput()
    
    // 图形输出
    data class GraphicalOutput(
        val text: String,
        val graphicalData: GraphicalOutputData
    ) : SkillOutput()
    
    // 交互式输出
    data class InteractiveOutput(
        val text: String,
        val followUpSkill: Skill<String>
    ) : SkillOutput()
}
```

### 2. 输出渲染
- **文本输出**: TTS 语音播报 + 文本显示
- **图形输出**: 卡片式界面显示
- **交互输出**: 等待用户后续输入

## 技能开发指南

### 1. 创建新技能步骤

1. **定义句式**
   - 在 `skill_definitions.yml` 中添加技能定义
   - 在各语言文件夹中添加句式文件

2. **实现技能类**
   ```kotlin
   class MySkill(info: SkillInfo, data: StandardRecognizerData<MySkillType>) 
       : StandardRecognizerSkill<MySkillType>(info, data) {
       
       override suspend fun generateOutput(
           ctx: SkillContext, 
           inputData: MySkillType
       ): SkillOutput {
           // 实现技能逻辑
       }
   }
   ```

3. **创建技能信息**
   ```kotlin
   object MySkillInfo : SkillInfo("my_skill") {
       // 实现必要方法
   }
   ```

4. **注册技能**
   - 在 `SkillHandler.allSkillInfoList` 中添加

### 2. 最佳实践

#### 错误处理
```kotlin
override suspend fun generateOutput(ctx: SkillContext, inputData: MySkill): SkillOutput {
    return try {
        // 技能逻辑
        MySkillOutput.Success(result)
    } catch (e: Exception) {
        MySkillOutput.Error(ctx.getString(R.string.error_message))
    }
}
```

#### 权限处理
```kotlin
override val neededPermissions: List<Permission> = listOf(
    PERMISSION_INTERNET,
    PERMISSION_LOCATION
)
```

#### 异步操作
```kotlin
override suspend fun generateOutput(ctx: SkillContext, inputData: MySkill): SkillOutput {
    return withContext(Dispatchers.IO) {
        // 网络请求或文件操作
    }
}
```

## 技能系统优化

### 1. 性能优化
- **懒加载**: 技能按需初始化
- **缓存机制**: 句式编译结果缓存
- **并发处理**: 多技能并行评分

### 2. 内存管理
- **资源释放**: 及时清理不用的技能资源
- **状态管理**: 避免内存泄漏

### 3. 用户体验
- **快速响应**: 优化技能执行时间
- **错误恢复**: 友好的错误提示
- **上下文保持**: 支持多轮对话

技能系统是 Dicio 的核心竞争力，通过模块化设计和标准化接口，实现了高度的可扩展性和维护性。
