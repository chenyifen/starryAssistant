# Dicio 语音处理系统

## 系统概述

Dicio 的语音处理系统是整个语音助手的核心引擎，负责将用户的语音输入转换为文本，并将助手的回复转换为语音输出。系统采用模块化设计，支持多种输入输出设备的灵活配置。

## 架构设计

### 语音处理流水线
```
语音输入 → STT设备 → 文本处理 → 技能匹配 → 输出生成 → TTS设备 → 语音输出
    ↓         ↓         ↓         ↓         ↓         ↓         ↓
  麦克风   → Vosk/STT → 文本清理 → 技能评分 → 结果生成 → TTS引擎 → 扬声器
```

### 核心组件
- **输入设备管理**: 语音输入设备抽象和实现
- **输出设备管理**: 语音输出设备抽象和实现
- **唤醒词检测**: 语音唤醒功能
- **事件处理**: 语音输入事件流处理

## 语音输入系统

### 1. 输入设备架构

#### SttInputDevice 接口
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/input/SttInputDevice.kt`
- **职责**: 语音转文本设备抽象接口

```kotlin
interface SttInputDevice {
    val uiState: StateFlow<SttState>
    
    fun tryLoad(thenStartListeningEventListener: ((InputEvent) -> Unit)?)
    fun startListening(eventListener: (InputEvent) -> Unit)
    fun stopListening()
    fun reinitializeToReleaseResources()
}
```

#### 输入设备状态
```kotlin
sealed class SttState {
    object NotAvailable : SttState()
    object NotDownloaded : SttState()
    data class Downloading(val progress: Progress) : SttState()
    object NotInitialized : SttState()
    object NotLoaded : SttState()
    data class Loading(val progress: Progress?) : SttState()
    object Available : SttState()
    object Listening : SttState()
    data class Error(val throwable: Throwable) : SttState()
}
```

### 2. Vosk 离线语音识别

#### VoskInputDevice
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/input/vosk/VoskInputDevice.kt`
- **特性**: 完全离线的语音识别
- **优势**: 隐私保护、无网络依赖、低延迟

##### 核心功能
```kotlin
class VoskInputDevice(
    @ApplicationContext appContext: Context,
    private val okHttpClient: OkHttpClient,
    localeManager: LocaleManager,
) : SttInputDevice {
    
    // 模型管理
    private val modelDirectory: File
    private val modelZipFile: File
    
    // 状态管理
    private val _state: MutableStateFlow<VoskState>
    private val _uiState: MutableStateFlow<SttState>
    
    // 语音服务
    private var speechService: SpeechService?
}
```

##### 模型下载和管理
```kotlin
private suspend fun downloadModel(locale: Locale): VoskState {
    val modelInfo = getModelInfo(locale) ?: return NotAvailable
    
    return try {
        // 下载模型文件
        downloadBinaryFilesWithPartial(
            okHttpClient = okHttpClient,
            files = listOf(FileToDownload(modelInfo.url, modelZipFile)),
            onProgress = { progress ->
                _state.value = Downloading(progress)
            }
        )
        
        // 解压模型
        _state.value = Unzipping
        extractZip(modelZipFile, modelDirectory)
        
        NotLoaded
    } catch (e: Exception) {
        ErrorDownloading(e)
    }
}
```

##### 语音识别处理
```kotlin
private fun startListening(speechService: SpeechService, eventListener: (InputEvent) -> Unit) {
    speechService.startListening(object : RecognitionListener {
        override fun onPartialResult(hypothesis: String?) {
            hypothesis?.let { 
                eventListener(InputEvent.Partial(it))
            }
        }
        
        override fun onResult(hypothesis: String?) {
            val results = parseResults(hypothesis)
            eventListener(InputEvent.Final(results))
        }
        
        override fun onError(exception: Exception) {
            eventListener(InputEvent.Error(exception))
        }
    })
}
```

#### VoskListener
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/input/vosk/VoskListener.kt`
- **职责**: Vosk识别结果监听和处理

### 3. Android STT 在线识别

#### AndroidSttInputDevice
- **特性**: 使用系统内置STT服务
- **优势**: 识别准确率高、支持多语言
- **劣势**: 需要网络连接、隐私考虑

### 4. 外部弹窗输入

#### ExternalPopupInputDevice
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/input/external_popup/ExternalPopupInputDevice.kt`
- **功能**: 独立弹窗的语音输入
- **用途**: 快速语音输入场景

### 5. STT服务

#### SttService
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/input/stt_service/SttService.kt`
- **功能**: 作为系统STT服务提供商
- **特性**: 允许其他应用使用Dicio的STT能力

```kotlin
@AndroidEntryPoint
class SttService : RecognitionService() {
    @Inject lateinit var sttInputDevice: SttInputDeviceWrapper
    @Inject lateinit var localeManager: LocaleManager
    
    override fun onStartListening(recognizerIntent: Intent, callback: Callback) {
        // 处理识别请求
        sttInputDevice.startListening { event ->
            when (event) {
                is InputEvent.Partial -> callback.partialResults(...)
                is InputEvent.Final -> callback.results(...)
                is InputEvent.Error -> callback.error(...)
            }
        }
    }
}
```

## 语音输出系统

### 1. 输出设备架构

#### SpeechOutputDevice 接口
```kotlin
interface SpeechOutputDevice {
    fun speak(speechOutput: String)
    fun stopSpeaking()
    fun cleanup()
    fun runWhenFinishedSpeaking(runnable: Runnable)
}
```

### 2. Android TTS 输出

#### AndroidTtsSpeechDevice
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/speech/AndroidTtsSpeechDevice.kt`
- **功能**: 使用系统TTS引擎进行语音合成

```kotlin
class AndroidTtsSpeechDevice(
    private var context: Context, 
    locale: Locale
) : SpeechOutputDevice {
    
    private var textToSpeech: TextToSpeech?
    private var initializedCorrectly = false
    
    init {
        textToSpeech = TextToSpeech(context) { status ->
            if (status == TextToSpeech.SUCCESS) {
                setupTts(locale)
            }
        }
    }
    
    override fun speak(speechOutput: String) {
        if (initializedCorrectly) {
            textToSpeech?.speak(
                speechOutput,
                TextToSpeech.QUEUE_FLUSH,
                null,
                "dicio_$lastUtteranceId"
            )
        }
    }
}
```

### 3. 即时输出设备

#### InstantSpeechDevice
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/speech/InstantSpeechDevice.kt`
- **特性**: 无延迟的即时输出基类

#### ToastSpeechDevice
- **功能**: 使用Toast显示文本输出
- **用途**: 调试和无声环境

#### SnackbarSpeechDevice
- **功能**: 使用Snackbar显示文本输出
- **特性**: 更好的用户体验，可交互

```kotlin
@Singleton
class SnackbarSpeechDevice @Inject constructor() : InstantSpeechDevice() {
    private val _events = MutableSharedFlow<String?>(0, 1, BufferOverflow.DROP_OLDEST)
    val events: SharedFlow<String?> = _events
    
    override fun speak(speechOutput: String) {
        _events.tryEmit(speechOutput)
    }
    
    override fun stopSpeaking() {
        _events.tryEmit(null)
    }
}
```

## 语音唤醒系统

### 1. 唤醒设备架构

#### WakeDevice 接口
```kotlin
interface WakeDevice {
    val state: StateFlow<WakeState>
    
    fun tryLoad()
    fun startListening(eventListener: (WakeEvent) -> Unit)
    fun stopListening()
    fun reinitializeToReleaseResources()
}
```

#### 唤醒状态
```kotlin
sealed class WakeState {
    object NotLoaded : WakeState()
    object Loading : WakeState()
    object Loaded : WakeState()
    object Listening : WakeState()
    data class Error(val throwable: Throwable) : WakeState()
}
```

### 2. Hey Dicio 唤醒

#### HeyDicioWakeDevice
- **功能**: 基于"Hey Dicio"唤醒词的检测
- **实现**: 简单的关键词匹配

### 3. OpenWakeWord 唤醒

#### OpenWakeWordDevice
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/wake/oww/OpenWakeWordDevice.kt`
- **功能**: 基于机器学习的唤醒词检测
- **特性**: 支持自定义唤醒词、高准确率

```kotlin
class OpenWakeWordDevice(
    @ApplicationContext private val appContext: Context,
    private val okHttpClient: OkHttpClient,
) : WakeDevice {
    
    // 模型管理
    private val modelFiles: List<File>
    private val userWakeFile: File
    
    // 音频处理
    private var audioRecord: AudioRecord?
    private var interpreter: Interpreter?
    
    fun addUserWakeFile(context: Context, uri: Uri) {
        // 添加用户自定义唤醒词文件
    }
    
    private fun processAudioBuffer(audioBuffer: FloatArray): Boolean {
        // 使用TensorFlow Lite进行唤醒词检测
        val input = preprocessAudio(audioBuffer)
        val output = Array(1) { FloatArray(1) }
        
        interpreter?.run(input, output)
        
        return output[0][0] > WAKE_THRESHOLD
    }
}
```

### 4. 唤醒服务

#### WakeService
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/wake/WakeService.kt`
- **功能**: 后台唤醒词检测服务
- **特性**: 前台服务、低功耗、持续监听

```kotlin
class WakeService : Service() {
    companion object {
        fun start(context: Context) {
            val intent = Intent(context, WakeService::class.java)
            context.startForegroundService(intent)
        }
        
        fun stop(context: Context) {
            val intent = Intent(context, WakeService::class.java)
            context.stopService(intent)
        }
        
        fun isRunning(): Boolean = isServiceRunning
    }
    
    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
        startForeground(NOTIFICATION_ID, createNotification())
        wakeDevice.startListening { event ->
            when (event) {
                is WakeEvent.Detected -> handleWakeDetected()
            }
        }
        return START_STICKY
    }
}
```

## 输入事件系统

### 1. 事件类型

#### InputEvent
```kotlin
sealed class InputEvent {
    object None : InputEvent()
    data class Partial(val utterance: String) : InputEvent()
    data class Final(val utterances: List<Pair<String, Float>>) : InputEvent()
    data class Error(val throwable: Throwable) : InputEvent()
}
```

### 2. 事件处理流程

```kotlin
class SkillEvaluator {
    override fun processInputEvent(event: InputEvent) {
        scope.launch {
            when (event) {
                is InputEvent.Partial -> {
                    // 更新UI显示部分识别结果
                    updatePendingInput(event.utterance)
                }
                
                is InputEvent.Final -> {
                    // 处理最终识别结果
                    val bestUtterance = event.utterances.maxByOrNull { it.second }?.first
                    if (bestUtterance != null) {
                        evaluateMatchingSkill(listOf(bestUtterance))
                    }
                }
                
                is InputEvent.Error -> {
                    // 处理识别错误
                    handleRecognitionError(event.throwable)
                }
                
                InputEvent.None -> {
                    // 清除待处理状态
                    clearPendingState()
                }
            }
        }
    }
}
```

## 设备管理和配置

### 1. 设备包装器

#### SttInputDeviceWrapper
- **文件**: `app/src/main/kotlin/org/stypox/dicio/di/SttInputDeviceWrapper.kt`
- **功能**: STT设备的统一包装和管理

```kotlin
@Singleton
class SttInputDeviceWrapper @Inject constructor(
    private val dataStore: DataStore<UserSettings>,
    private val voskInputDevice: VoskInputDevice,
    private val androidSttInputDevice: AndroidSttInputDevice,
    private val externalPopupInputDevice: ExternalPopupInputDevice,
) {
    val uiState: StateFlow<SttState>
    
    private fun getCurrentDevice(): SttInputDevice {
        return when (currentInputDevice) {
            InputDevice.INPUT_DEVICE_VOSK -> voskInputDevice
            InputDevice.INPUT_DEVICE_ANDROID_STT -> androidSttInputDevice
            InputDevice.INPUT_DEVICE_EXTERNAL_POPUP -> externalPopupInputDevice
            else -> voskInputDevice
        }
    }
}
```

#### WakeDeviceWrapper
- **功能**: 唤醒设备的统一包装和管理
- **特性**: 根据用户设置动态切换唤醒设备

### 2. 依赖注入配置

#### IoModule
- **文件**: `app/src/main/kotlin/org/stypox/dicio/di/IoModule.kt`
- **功能**: IO设备的依赖注入配置

```kotlin
@Module
@InstallIn(SingletonComponent::class)
class IoModule {
    
    @Provides
    @Singleton
    fun provideSttInputDeviceWrapper(...): SttInputDeviceWrapper = ...
    
    @Provides
    @Singleton
    fun provideWakeDeviceWrapper(...): WakeDeviceWrapper = ...
    
    @Provides
    @Singleton
    fun provideSpeechOutputDeviceWrapper(...): SpeechOutputDeviceWrapper = ...
}
```

## 性能优化

### 1. 内存管理
- **资源释放**: 及时释放音频资源和模型
- **懒加载**: 按需加载语音模型
- **缓存策略**: 合理缓存识别结果

### 2. 电池优化
- **后台限制**: 合理使用后台服务
- **CPU优化**: 优化音频处理算法
- **唤醒优化**: 低功耗唤醒词检测

### 3. 响应性优化
- **异步处理**: 所有IO操作异步执行
- **流式处理**: 实时显示识别结果
- **错误恢复**: 快速从错误状态恢复

## 隐私和安全

### 1. 数据保护
- **本地处理**: Vosk完全离线处理
- **数据不存储**: 不保存语音数据
- **权限最小化**: 只请求必要权限

### 2. 用户控制
- **设备选择**: 用户可选择STT设备
- **唤醒控制**: 可关闭语音唤醒
- **数据清理**: 支持清理缓存数据

语音处理系统是Dicio的核心技术优势，通过模块化设计和多设备支持，为用户提供了灵活、高效、隐私安全的语音交互体验。
