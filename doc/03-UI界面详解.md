# Dicio UI界面详解

## UI架构概述

Dicio 采用 Jetpack Compose 构建现代化的用户界面，遵循 Material 3 设计规范，实现了响应式和声明式的UI开发模式。

## 技术栈

### 核心UI技术
- **Jetpack Compose**: 声明式UI框架
- **Material 3**: 最新设计系统
- **Navigation Compose**: 类型安全导航
- **ViewModel**: MVVM架构模式
- **StateFlow**: 响应式状态管理

### UI相关依赖
```kotlin
androidx.compose:compose-bom:2025.02.00
androidx.activity:activity-compose:1.10.0
androidx.navigation:navigation-compose:2.8.7
androidx.compose.material3:material3
androidx.compose.material:material-icons-extended
```

## 界面结构

### 1. 主要界面

#### MainActivity
- **文件**: `app/src/main/kotlin/org/stypox/dicio/MainActivity.kt`
- **职责**: 应用入口点，管理全局状态
- **功能**:
  - 处理语音助手意图 (ACTION_ASSIST, ACTION_VOICE_COMMAND)
  - 管理权限请求
  - 初始化核心组件
  - 设置主题和边缘到边缘显示

```kotlin
@AndroidEntryPoint
class MainActivity : BaseActivity() {
    @Inject lateinit var skillEvaluator: SkillEvaluator
    @Inject lateinit var sttInputDevice: SttInputDeviceWrapper
    @Inject lateinit var wakeDevice: WakeDeviceWrapper
    
    override fun onCreate(savedInstanceState: Bundle?) {
        // 处理语音助手意图
        // 设置权限监听
        // 初始化Compose UI
    }
}
```

#### BaseActivity
- **文件**: `app/src/main/kotlin/org/stypox/dicio/util/BaseActivity.kt`
- **职责**: 活动基类，处理通用功能
- **功能**:
  - 主题设置和动态颜色
  - 语言本地化
  - 边缘到边缘显示配置

### 2. 导航系统

#### Navigation
- **文件**: `app/src/main/kotlin/org/stypox/dicio/ui/nav/Navigation.kt`
- **架构**: 类型安全导航系统

```kotlin
@Composable
fun Navigation() {
    val navController = rememberNavController()
    
    NavHost(navController = navController, startDestination = Home) {
        composable<Home> { HomeScreen(it) }
        composable<MainSettings> { MainSettingsScreen(...) }
        composable<SkillSettings> { SkillSettingsScreen(...) }
    }
}
```

#### 路由定义
- **文件**: `app/src/main/kotlin/org/stypox/dicio/ui/nav/Routes.kt`

```kotlin
@Serializable
object Home

@Serializable
object MainSettings

@Serializable
object SkillSettings
```

### 3. 主界面 (HomeScreen)

#### 界面组成
- **文件**: `app/src/main/kotlin/org/stypox/dicio/ui/home/HomeScreen.kt`
- **布局**: 带侧边抽屉的主界面

```kotlin
@Composable
fun HomeScreen(navigationIcon: @Composable () -> Unit) {
    // 权限处理
    // 状态管理
    // 交互界面
}
```

#### 核心功能组件

##### 1. 语音交互区域
- **语音输入按钮**: 触发语音识别
- **状态指示器**: 显示识别状态
- **波形动画**: 语音输入视觉反馈

##### 2. 交互历史
- **对话列表**: 显示用户输入和助手回复
- **技能输出**: 不同类型的输出渲染
- **错误处理**: 友好的错误信息显示

##### 3. 快捷操作
- **常用技能**: 快速访问常用功能
- **设置入口**: 跳转到设置界面
- **语音弹窗**: STT弹窗快捷方式

#### HomeScreenViewModel
- **文件**: `app/src/main/kotlin/org/stypox/dicio/ui/home/HomeScreenViewModel.kt`
- **职责**: 主界面状态管理

```kotlin
@HiltViewModel
class HomeScreenViewModel @Inject constructor(
    val skillHandler: SkillHandler,
    val skillEvaluator: SkillEvaluator,
    val sttInputDevice: SttInputDeviceWrapper,
    val wakeDevice: WakeDeviceWrapper
) : ViewModel()
```

### 4. 设置界面

#### 主设置界面 (MainSettingsScreen)
- **文件**: `app/src/main/kotlin/org/stypox/dicio/settings/MainSettingsScreen.kt`
- **布局**: 分类设置列表

##### 设置分类

###### 1. 通用设置
- **语言选择**: 支持12+种语言
- **主题设置**: 浅色/深色/跟随系统
- **动态颜色**: Material You 动态主题 (Android 12+)

###### 2. 输入输出设置
- **输入设备**: Vosk离线/Android在线STT
- **唤醒设备**: Hey Dicio/OpenWakeWord/无
- **语音输出**: Android TTS/Toast/Snackbar
- **STT声音**: 开始/结束提示音

###### 3. 高级设置
- **STT弹窗**: 自动关闭设置
- **权限管理**: 各项权限状态
- **调试选项**: 开发者选项

#### MainSettingsViewModel
- **文件**: `app/src/main/kotlin/org/stypox/dicio/settings/MainSettingsViewModel.kt`
- **功能**: 设置数据管理

```kotlin
@HiltViewModel
class MainSettingsViewModel @Inject constructor(
    private val dataStore: DataStore<UserSettings>
) : AndroidViewModel(application) {
    
    val settingsState = dataStore.data.toStateFlowDistinctBlockingFirst(viewModelScope)
    
    // 设置更新方法
    fun setLanguage(value: Language) = updateData { it.setLanguage(value) }
    fun setTheme(value: Theme) = updateData { it.setTheme(value) }
    // ...
}
```

#### 技能设置界面 (SkillSettingsScreen)
- **文件**: `app/src/main/kotlin/org/stypox/dicio/settings/SkillSettingsScreen.kt`
- **功能**: 管理技能启用/禁用状态

```kotlin
@Composable
fun SkillSettingsScreen(navigationIcon: @Composable () -> Unit) {
    LazyColumn {
        items(enabledSkillsInfo) { skillInfo ->
            SkillSettingItem(
                skillInfo = skillInfo,
                enabled = enabledSkills[skillInfo.id] ?: true,
                onEnabledChange = { viewModel.setSkillEnabled(skillInfo.id, it) }
            )
        }
    }
}
```

### 5. 设置UI组件

#### 设置组件系统
- **文件**: `app/src/main/kotlin/org/stypox/dicio/settings/ui/`

##### 核心组件

###### SettingWithValue<T> 接口
```kotlin
interface SettingWithValue<T> {
    @Composable
    fun Render(value: T, onValueChange: (T) -> Unit)
}
```

###### BooleanSetting
- **功能**: 开关设置项
- **UI**: Switch + 标题 + 描述

###### ListSetting<T>
- **功能**: 列表选择设置
- **UI**: 单选对话框

###### TextSetting
- **功能**: 文本输入设置
- **UI**: 文本输入框

##### 设置项组件

###### SettingsItem
```kotlin
@Composable
fun SettingsItem(
    title: String,
    icon: ImageVector? = null,
    description: String? = null,
    content: @Composable () -> Unit = {},
    modifier: Modifier = Modifier
)
```

###### SettingsCategoryTitle
```kotlin
@Composable
fun SettingsCategoryTitle(
    title: String,
    topPadding: Dp = 16.dp
)
```

### 6. 语音弹窗界面

#### SttPopupActivity
- **文件**: `app/src/main/kotlin/org/stypox/dicio/io/input/stt_popup/SttPopupActivity.kt`
- **功能**: 独立的语音输入弹窗
- **特性**:
  - 浮动窗口样式
  - 快速语音输入
  - 自动关闭选项

### 7. 主题系统

#### AppTheme
- **文件**: `app/src/main/kotlin/org/stypox/dicio/ui/theme/AppTheme.kt`
- **功能**: 应用主题配置

```kotlin
@Composable
fun AppTheme(
    theme: Theme,
    dynamicColors: Boolean,
    content: @Composable () -> Unit
) {
    val colorScheme = when {
        dynamicColors && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
            val context = LocalContext.current
            if (isSystemInDarkTheme()) dynamicDarkColorScheme(context)
            else dynamicLightColorScheme(context)
        }
        theme == Theme.THEME_DARK -> DarkColorScheme
        theme == Theme.THEME_LIGHT -> LightColorScheme
        else -> if (isSystemInDarkTheme()) DarkColorScheme else LightColorScheme
    }
    
    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        content = content
    )
}
```

### 8. 通用UI组件

#### 导航组件

##### AppBar
- **文件**: `app/src/main/kotlin/org/stypox/dicio/ui/nav/AppBar.kt`
- **功能**: 统一的应用栏组件

##### ScreenWithDrawer
- **功能**: 带侧边抽屉的屏幕容器
- **特性**:
  - 手势导航
  - 设置快捷入口
  - STT弹窗入口

#### 状态组件

##### 加载状态
- **Progress组件**: 显示加载进度
- **错误状态**: 友好的错误信息
- **空状态**: 无数据时的提示

##### 权限状态
- **权限请求**: 动态权限申请
- **权限说明**: 权限用途解释

### 9. 响应式设计

#### 屏幕适配
- **密度适配**: 支持不同屏幕密度
- **尺寸适配**: 响应式布局
- **方向适配**: 横竖屏切换

#### 无障碍支持
- **语义标签**: Compose语义系统
- **焦点管理**: 键盘导航支持
- **对比度**: 符合无障碍标准

### 10. 状态管理

#### 状态流转
```kotlin
// UI状态定义
data class HomeUiState(
    val isListening: Boolean = false,
    val interactions: List<Interaction> = emptyList(),
    val currentInput: String = "",
    val error: String? = null
)

// 状态更新
class HomeViewModel : ViewModel() {
    private val _uiState = MutableStateFlow(HomeUiState())
    val uiState: StateFlow<HomeUiState> = _uiState.asStateFlow()
    
    fun updateState(update: HomeUiState.() -> HomeUiState) {
        _uiState.value = _uiState.value.update()
    }
}
```

#### 副作用处理
```kotlin
@Composable
fun HomeScreen() {
    val uiState by viewModel.uiState.collectAsState()
    
    // 副作用处理
    LaunchedEffect(uiState.error) {
        uiState.error?.let { error ->
            // 显示错误信息
            snackbarHostState.showSnackbar(error)
        }
    }
}
```

## UI开发最佳实践

### 1. 组件设计原则
- **单一职责**: 每个组件专注单一功能
- **可复用性**: 通用组件提取复用
- **可测试性**: 支持UI测试

### 2. 状态管理
- **单向数据流**: 状态向下，事件向上
- **不可变状态**: 使用不可变数据结构
- **状态提升**: 在合适层级管理状态

### 3. 性能优化
- **重组优化**: 避免不必要的重组
- **懒加载**: 大列表使用LazyColumn
- **内存管理**: 及时释放资源

### 4. 用户体验
- **加载状态**: 提供加载反馈
- **错误处理**: 友好的错误提示
- **动画效果**: 适当的过渡动画

Dicio的UI系统通过现代化的Compose框架，实现了美观、易用、高性能的用户界面，为语音助手提供了优秀的交互体验。
