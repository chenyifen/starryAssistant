# Dicio å¤šå”¤é†’æŠ€æœ¯é›†æˆæŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†Dicio Androidé¡¹ç›®ä¸­å¤šå”¤é†’æŠ€æœ¯çš„é›†æˆå®ç°ï¼ŒåŒ…æ‹¬OpenWakeWordå’ŒSherpaOnnx KWSçš„æ”¯æŒã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒç»„ä»¶

```
å¤šå”¤é†’æŠ€æœ¯æ¶æ„
â”œâ”€â”€ WakeDevice (æ¥å£)
â”‚   â”œâ”€â”€ OpenWakeWordDevice (ç°æœ‰)
â”‚   â””â”€â”€ SherpaOnnxWakeDevice (æ–°å¢)
â”œâ”€â”€ WakeDeviceWrapper (å·¥å‚)
â”œâ”€â”€ WakeState (çŠ¶æ€ç®¡ç†)
â””â”€â”€ Settings UI (é…ç½®ç•Œé¢)
```

### 2. çŠ¶æ€ç®¡ç†

æ‰€æœ‰å”¤é†’è®¾å¤‡å…±äº«ç›¸åŒçš„çŠ¶æ€è½¬æ¢æ¨¡å¼ï¼š
- `NotDownloaded` â†’ `Downloading` â†’ `NotLoaded` â†’ `Loading` â†’ `Loaded`
- é”™è¯¯çŠ¶æ€ï¼š`ErrorDownloading`ã€`ErrorLoading`

## ğŸ“‹ å®ç°æ¸…å•

### âœ… å·²å®Œæˆçš„å·¥ä½œ

#### 1. **Protoé…ç½®æ›´æ–°**
- ğŸ“„ `app/src/main/proto/wake_device.proto`
- æ·»åŠ äº† `WAKE_DEVICE_SHERPA_ONNX = 3`

#### 2. **SherpaOnnxè®¾å¤‡å®ç°**
- ğŸ“„ `app/src/main/kotlin/org/stypox/dicio/io/wake/sherpa/SherpaOnnxWakeDevice.kt`
- å®ç°äº†å®Œæ•´çš„WakeDeviceæ¥å£
- æ”¯æŒæ¨¡å‹è‡ªåŠ¨å¤åˆ¶å’ŒåŠ è½½
- é›†æˆäº†è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ
- å…¼å®¹ç°æœ‰çš„éŸ³é¢‘å¤„ç†æµç¨‹

#### 3. **å·¥å‚æ¨¡å¼æ›´æ–°**
- ğŸ“„ `app/src/main/kotlin/org/stypox/dicio/di/WakeDeviceWrapper.kt`
- æ›´æ–°äº† `buildInputDevice()` æ–¹æ³•
- æ”¯æŒåŠ¨æ€åˆ‡æ¢å”¤é†’æŠ€æœ¯

#### 4. **è®¾ç½®ç•Œé¢é›†æˆ**
- ğŸ“„ `app/src/main/kotlin/org/stypox/dicio/settings/Definitions.kt`
- ğŸ“„ `app/src/main/kotlin/org/stypox/dicio/settings/MainSettingsScreen.kt`
- ğŸ“„ `app/src/main/res/values/strings.xml`
- æ·»åŠ äº†SherpaOnnxé€‰é¡¹åˆ°å”¤é†’æ–¹æ³•è®¾ç½®
- æ”¯æŒç‰¹å®šæŠ€æœ¯çš„é…ç½®é€‰é¡¹

## ğŸ”§ æŠ€æœ¯ç‰¹æ€§

### 1. **ç»Ÿä¸€æ¥å£è®¾è®¡**

```kotlin
interface WakeDevice {
    val state: StateFlow<WakeState>
    fun download()
    fun processFrame(audio16bitPcm: ShortArray): Boolean
    fun frameSize(): Int
    fun destroy()
    fun isHeyDicio(): Boolean
}
```

### 2. **æ™ºèƒ½æ¨¡å‹ç®¡ç†**

```kotlin
// è‡ªåŠ¨æ£€æµ‹å’Œå¤åˆ¶é¢„æ‰“åŒ…æ¨¡å‹
private fun hasModelsAvailable(): Boolean {
    return hasLocalModels() || hasSherpaModelsInAssets()
}

// æ”¯æŒassetsé¢„æ‰“åŒ…
private fun copySherpaModelsFromAssets(): Boolean {
    // ä»assetså¤åˆ¶åˆ°å†…éƒ¨å­˜å‚¨
}
```

### 3. **è°ƒè¯•é›†æˆ**

```kotlin
// ç»Ÿä¸€çš„è°ƒè¯•æ—¥å¿—
DebugLogger.logWakeWord(TAG, "ğŸš€ Initializing SherpaOnnxWakeDevice")
DebugLogger.logWakeWordDetection(TAG, confidence, threshold, detected)

// éŸ³é¢‘æ•°æ®ä¿å­˜
AudioDebugSaver.saveWakeAudio(appContext, audio16bitPcm, amplitude, confidence)
```

## ğŸ“± ç”¨æˆ·ä½“éªŒ

### 1. **è®¾ç½®ç•Œé¢**

ç”¨æˆ·å¯ä»¥åœ¨ `è®¾ç½® â†’ è¾“å…¥è¾“å‡ºæ–¹æ³• â†’ å”¤é†’è¯è¯†åˆ«æ–¹æ³•` ä¸­é€‰æ‹©ï¼š
- **OpenWakeWord offline audio processing** (ç°æœ‰)
- **SherpaOnnx KWS (Keyword Spotting)** (æ–°å¢)
- **Disabled** (ç¦ç”¨)

### 2. **åŠ¨æ€åˆ‡æ¢**

- åˆ‡æ¢å”¤é†’æŠ€æœ¯æ—¶è‡ªåŠ¨é‡Šæ”¾æ—§èµ„æº
- æ–°æŠ€æœ¯è‡ªåŠ¨åˆå§‹åŒ–å’Œæ¨¡å‹åŠ è½½
- ä¿æŒéŸ³é¢‘å¤„ç†çš„è¿ç»­æ€§

### 3. **ç‰¹å®šé…ç½®**

æ¯ç§æŠ€æœ¯éƒ½æœ‰ä¸“é—¨çš„é…ç½®é€‰é¡¹ï¼š
- **OpenWakeWord**: è‡ªå®šä¹‰æ¨¡å‹å¯¼å…¥/åˆ é™¤
- **SherpaOnnx**: å‚æ•°é…ç½®å’Œå”¤é†’è¯ç®¡ç†

## ğŸ”„ çŠ¶æ€è½¬æ¢æµç¨‹

### 1. **åˆå§‹åŒ–æµç¨‹**

```mermaid
graph TD
    A[ç”¨æˆ·é€‰æ‹©SherpaOnnx] --> B[WakeDeviceWrapper.changeWakeDeviceTo]
    B --> C[é”€æ¯æ—§è®¾å¤‡]
    C --> D[åˆ›å»ºSherpaOnnxWakeDevice]
    D --> E[æ£€æŸ¥æ¨¡å‹å¯ç”¨æ€§]
    E --> F{æ¨¡å‹å­˜åœ¨?}
    F -->|æ˜¯| G[NotLoadedçŠ¶æ€]
    F -->|å¦| H[NotDownloadedçŠ¶æ€]
    G --> I[é¦–æ¬¡processFrameè°ƒç”¨]
    I --> J[LoadingçŠ¶æ€]
    J --> K[åŠ è½½SherpaOnnxæ¨¡å‹]
    K --> L[LoadedçŠ¶æ€]
```

### 2. **è¿è¡Œæ—¶æµç¨‹**

```mermaid
graph TD
    A[éŸ³é¢‘å¸§è¾“å…¥] --> B[SherpaOnnxWakeDevice.processFrame]
    B --> C[è½¬æ¢ä¸ºFloatæ•°ç»„]
    C --> D[SherpaOnnxå¤„ç†]
    D --> E{æ£€æµ‹åˆ°å”¤é†’è¯?}
    E -->|æ˜¯| F[è¿”å›true + è®°å½•æ—¥å¿—]
    E -->|å¦| G[è¿”å›false]
    F --> H[WakeServiceè§¦å‘å”¤é†’]
    G --> I[ç»§ç»­ç›‘å¬]
```

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### 1. **æ·»åŠ æ–°çš„å”¤é†’æŠ€æœ¯**

è¦æ·»åŠ æ–°çš„å”¤é†’æŠ€æœ¯ï¼Œéœ€è¦ï¼š

1. **æ›´æ–°Protoå®šä¹‰**
```proto
enum WakeDevice {
  // ...ç°æœ‰é€‰é¡¹
  WAKE_DEVICE_NEW_TECH = 4;
}
```

2. **å®ç°WakeDeviceæ¥å£**
```kotlin
class NewTechWakeDevice(
    private val appContext: Context
) : WakeDevice {
    // å®ç°æ‰€æœ‰å¿…éœ€æ–¹æ³•
}
```

3. **æ›´æ–°å·¥å‚æ–¹æ³•**
```kotlin
private fun buildInputDevice(setting: DataStoreWakeDevice): WakeDevice? {
    return when (setting) {
        // ...ç°æœ‰case
        WAKE_DEVICE_NEW_TECH -> NewTechWakeDevice(appContext)
    }
}
```

4. **æ·»åŠ UIé…ç½®**
```kotlin
// åœ¨Definitions.ktä¸­æ·»åŠ é€‰é¡¹
// åœ¨MainSettingsScreen.ktä¸­æ·»åŠ ç‰¹å®šè®¾ç½®
```

### 2. **æ¨¡å‹æ–‡ä»¶ç®¡ç†**

æ¨èçš„æ¨¡å‹æ–‡ä»¶ç»„ç»‡ç»“æ„ï¼š
```
app/src/main/assets/models/
â”œâ”€â”€ openWakeWord/
â”‚   â”œâ”€â”€ melspectrogram.tflite
â”‚   â”œâ”€â”€ embedding.tflite
â”‚   â””â”€â”€ wake.tflite
â””â”€â”€ sherpa_kws/
    â”œâ”€â”€ encoder-epoch-12-avg-2-chunk-16-left-64.onnx
    â”œâ”€â”€ decoder-epoch-12-avg-2-chunk-16-left-64.onnx
    â”œâ”€â”€ joiner-epoch-12-avg-2-chunk-16-left-64.onnx
    â”œâ”€â”€ tokens.txt
    â””â”€â”€ keywords.txt
```

### 3. **è°ƒè¯•å’Œæµ‹è¯•**

ä½¿ç”¨ç°æœ‰çš„è°ƒè¯•ç³»ç»Ÿï¼š
```kotlin
// å¯ç”¨è°ƒè¯•æ—¥å¿—
DebugLogger.logWakeWord(TAG, "è°ƒè¯•ä¿¡æ¯")

// ä¿å­˜éŸ³é¢‘æ•°æ®
AudioDebugSaver.saveWakeAudio(context, audioData, amplitude, confidence)

// æ‹‰å–è°ƒè¯•æ•°æ®
./scripts/pull_audio_debug.sh
```

## ğŸ” æ•…éšœæ’é™¤

### 1. **å¸¸è§é—®é¢˜**

#### é—®é¢˜ï¼šSherpaOnnxæ¨¡å‹æœªåŠ è½½
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥assetsä¸­æ˜¯å¦æœ‰æ¨¡å‹æ–‡ä»¶
2. éªŒè¯æ–‡ä»¶å¤åˆ¶æ˜¯å¦æˆåŠŸ
3. æŸ¥çœ‹è°ƒè¯•æ—¥å¿—ç¡®è®¤é”™è¯¯åŸå› 

#### é—®é¢˜ï¼šåˆ‡æ¢å”¤é†’æŠ€æœ¯åæ— å“åº”
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤WakeServiceé‡å¯
2. æ£€æŸ¥éŸ³é¢‘æƒé™
3. éªŒè¯æ–°è®¾å¤‡çš„frameSize()åŒ¹é…

#### é—®é¢˜ï¼šç¼–è¯‘é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è¿è¡Œ `./gradlew clean`
2. é‡æ–°ç”ŸæˆProtoæ–‡ä»¶
3. æ£€æŸ¥å¯¼å…¥è¯­å¥

### 2. **è°ƒè¯•å‘½ä»¤**

```bash
# æŸ¥çœ‹å”¤é†’æ£€æµ‹æ—¥å¿—
adb logcat | grep "ğŸ¯\[.*WakeDevice\]"

# æŸ¥çœ‹çŠ¶æ€è½¬æ¢
adb logcat | grep "ğŸ”„.*State"

# æŸ¥çœ‹æ¨¡å‹ç®¡ç†
adb logcat | grep "ğŸ“¦\[.*\]"

# æ‹‰å–éŸ³é¢‘è°ƒè¯•æ•°æ®
./scripts/pull_audio_debug.sh
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. **å†…å­˜ç®¡ç†**

```kotlin
override fun destroy() {
    // åŠæ—¶é‡Šæ”¾SherpaOnnxèµ„æº
    stream?.release()
    keywordSpotter?.release()
    stream = null
    keywordSpotter = null
}
```

### 2. **éŸ³é¢‘å¤„ç†ä¼˜åŒ–**

```kotlin
// é¿å…ä¸å¿…è¦çš„æ•°ç»„è½¬æ¢
private fun processSherpaFrame(audio16bitPcm: ShortArray): Boolean {
    // åªåœ¨éœ€è¦æ—¶è½¬æ¢ä¸ºfloat
    val audioFloat = FloatArray(audio16bitPcm.size) { i ->
        audio16bitPcm[i].toFloat() / Short.MAX_VALUE
    }
    return processMockSherpaFrame(audioFloat)
}
```

### 3. **çŠ¶æ€ç¼“å­˜**

```kotlin
// ç¼“å­˜æ¨¡å‹å¯ç”¨æ€§æ£€æŸ¥ç»“æœ
private var modelsAvailabilityCache: Boolean? = null

private fun hasModelsAvailable(): Boolean {
    return modelsAvailabilityCache ?: run {
        val result = hasLocalModels() || hasSherpaModelsInAssets()
        modelsAvailabilityCache = result
        result
    }
}
```

## ğŸš€ æœªæ¥æ‰©å±•

### 1. **è®¡åˆ’ä¸­çš„åŠŸèƒ½**

- [ ] çœŸå®SherpaOnnxåº“é›†æˆ
- [ ] å¤šè¯­è¨€å”¤é†’è¯æ”¯æŒ
- [ ] è‡ªå®šä¹‰å”¤é†’è¯è®­ç»ƒ
- [ ] äº‘ç«¯æ¨¡å‹ä¸‹è½½
- [ ] æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

### 2. **æ‰©å±•ç‚¹**

- **æ–°å”¤é†’æŠ€æœ¯**: å¯è½»æ¾æ·»åŠ å…¶ä»–KWSå¼•æ“
- **æ¨¡å‹æ ¼å¼**: æ”¯æŒæ›´å¤šæ¨¡å‹æ ¼å¼
- **é…ç½®é€‰é¡¹**: æ¯ç§æŠ€æœ¯çš„ä¸“é—¨é…ç½®
- **æ€§èƒ½è°ƒä¼˜**: é’ˆå¯¹ä¸åŒè®¾å¤‡çš„ä¼˜åŒ–

## ğŸ“š å‚è€ƒèµ„æº

### 1. **ç›¸å…³é¡¹ç›®**
- [OpenWakeWord](https://github.com/dscripka/openWakeWord)
- [SherpaOnnx](https://github.com/k2-fsa/sherpa-onnx)
- [HandsFreeé¡¹ç›®](https://github.com/starry-shivam/HandsFree)

### 2. **æŠ€æœ¯æ–‡æ¡£**
- [Dicioæ¶æ„æ–‡æ¡£](./01-é¡¹ç›®æ¶æ„æ€»è§ˆ.md)
- [çŠ¶æ€è½¬æ¢åˆ†æ](./18-çŠ¶æ€è½¬æ¢æœºåˆ¶åˆ†æ.md)
- [è°ƒè¯•æŒ‡å—](./15-å”¤é†’åŠŸèƒ½è°ƒè¯•æŒ‡å—.md)

## ğŸ“ æ€»ç»“

é€šè¿‡æœ¬æ¬¡é›†æˆï¼ŒDicioé¡¹ç›®ç°åœ¨æ”¯æŒï¼š

1. **å¤šç§å”¤é†’æŠ€æœ¯**: OpenWakeWord + SherpaOnnx KWS
2. **ç»Ÿä¸€æ¶æ„**: ç›¸åŒçš„æ¥å£å’ŒçŠ¶æ€ç®¡ç†
3. **çµæ´»é…ç½®**: ç”¨æˆ·å¯è‡ªç”±é€‰æ‹©å’Œåˆ‡æ¢
4. **å®Œæ•´è°ƒè¯•**: ç»Ÿä¸€çš„æ—¥å¿—å’ŒéŸ³é¢‘ä¿å­˜ç³»ç»Ÿ
5. **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„å”¤é†’æŠ€æœ¯

è¿™ä¸ºDicioæä¾›äº†æ›´å¼ºçš„è¯­éŸ³å”¤é†’èƒ½åŠ›å’Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚
