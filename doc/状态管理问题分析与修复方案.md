# è¯­éŸ³åŠ©æ‰‹çŠ¶æ€ç®¡ç†é—®é¢˜åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ

> æ—¥æœŸ: 2025-10-14  
> ä¼˜å…ˆçº§: ğŸ”´ é«˜  
> çŠ¶æ€: å¾…ä¿®å¤

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

ç”¨æˆ·å”¤é†’åæ²¡æœ‰è¯´è¯ï¼Œå¯¼è‡´è¶…æ—¶ï¼Œä½†ç³»ç»Ÿç»å†äº†å¤šä¸ªä¸åº”è¯¥å‡ºç°çš„çŠ¶æ€è½¬æ¢ï¼Œä¸”éŸ³é¢‘é‡‡é›†æ²¡æœ‰æ­£ç¡®åœæ­¢ã€‚

## ğŸ› é—®é¢˜æ—¥å¿—åˆ†æ

```log
09-20 22:25:20.294  SenseVoiceInputDevice: â° è¾¾åˆ°æœ€å¤§å½•åˆ¶æ—¶é—´
09-20 22:25:20.294  SenseVoiceInputDevice: ğŸ¯ å¼€å§‹æœ€ç»ˆè¯†åˆ«
09-20 22:25:20.302  SenseVoiceInputDevice: âš ï¸ æ²¡æœ‰æœ‰æ•ˆè¯­éŸ³æ•°æ®
09-20 22:25:20.311  VoiceAssistantStateProvider: ğŸ”‡ No speech detected
09-20 22:25:20.311  StateCoordinator: ğŸ”„ UI state changed: WAKE_DETECTED â†’ IDLE
09-20 22:25:20.311  VoiceAssistantStateProvider: â­ï¸ No significant state change, skipping notification
09-20 22:25:20.312  VoiceAssistantStateProvider: State updated: IDLE, text: 'LISTENING' âŒ
09-20 22:25:20.312  StateCoordinator: ğŸ¤ STT device loaded and ready âŒ
09-20 22:25:20.313  VoiceAssistantStateProvider: State updated: IDLE, text: ''
09-20 22:25:20.373  SenseVoiceInputDevice: ğŸ“Š éŸ³é¢‘æ•°æ®#300 (è¿˜åœ¨é‡‡é›†) âŒ
```

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1: âŒ è¶…æ—¶åçŠ¶æ€è®¾ç½®é”™è¯¯

**ä½ç½®**: `SenseVoiceInputDevice.kt:489`

```kotlin
private suspend fun processAudio() = withContext(Dispatchers.Default) {
    try {
        // ... å¤„ç†é€»è¾‘
    } finally {
        isRecording.set(false)
        _uiState.value = SttState.Loaded  // âŒ é”™è¯¯ï¼šåº”è¯¥æ˜¯ Idle
        Log.d(TAG, "ğŸ éŸ³é¢‘å¤„ç†ç»“æŸ")
    }
}
```

**é—®é¢˜**ï¼š
- æ— è®ºä½•ç§æƒ…å†µç»“æŸï¼ˆè¶…æ—¶ã€å¼‚å¸¸ã€æ­£å¸¸ï¼‰ï¼Œéƒ½è®¾ç½®ä¸º `Loaded`
- `Loaded` æ„å‘³ç€"å·²åŠ è½½ä¸”å‡†å¤‡å¥½"ï¼Œä¼šè§¦å‘ StateCoordinator æ‰“å° "STT device loaded and ready"
- å®é™…ä¸Šè¶…æ—¶ååº”è¯¥æ˜¯ `Idle` çŠ¶æ€

**å½±å“**ï¼š
1. StateCoordinator æ”¶åˆ° `Loaded` çŠ¶æ€
2. æ‰“å° "ğŸ¤ STT device loaded and ready"ï¼ˆä¸åº”è¯¥å‡ºç°ï¼‰
3. å¯èƒ½è§¦å‘ä¸å¿…è¦çš„çŠ¶æ€è½¬æ¢

### é—®é¢˜2: âŒ éŸ³é¢‘é‡‡é›†æ²¡æœ‰åœæ­¢

**ä½ç½®**: `SenseVoiceInputDevice.kt:328-404`

```kotlin
private suspend fun recordAudio() = withContext(Dispatchers.IO) {
    try {
        // åˆ›å»ºAudioRecord
        audioRecord = AudioRecord(...)
        audioRecord!!.startRecording()
        
        val audioBuffer = ShortArray(1600)
        
        while (isRecording.get()) {  // âŒ å¾ªç¯æ¡ä»¶
            val bytesRead = audioRecord!!.read(audioBuffer, 0, audioBuffer.size)
            // ... å¤„ç†
        }
        
    } finally {
        cleanupAudioRecord()  // æ¸…ç†
    }
}
```

**é—®é¢˜**ï¼š
- `isRecording.set(false)` åœ¨ `processAudio()` çš„ finally å—ä¸­è®¾ç½®
- ä½† `recordAudio()` æ˜¯ç‹¬ç«‹çš„åç¨‹ï¼Œå¯èƒ½è¿˜åœ¨ç­‰å¾… `read()` è¿”å›
- `read()` æ˜¯é˜»å¡è°ƒç”¨ï¼Œç›´åˆ°æœ‰æ•°æ®æ‰è¿”å›
- å¯¼è‡´ `while` å¾ªç¯è¿˜ä¼šå†æ‰§è¡Œä¸€æ¬¡ï¼Œè¯»å–åˆ° #300 çš„æ•°æ®

**å½±å“**ï¼š
1. è¶…æ—¶åæ—¥å¿—æ˜¾ç¤º "ğŸ“Š éŸ³é¢‘æ•°æ®#300"ï¼ˆä¸åº”è¯¥ç»§ç»­é‡‡é›†ï¼‰
2. AudioRecord æ²¡æœ‰ç«‹å³åœæ­¢
3. å¯èƒ½ä¸ WakeService çš„ AudioRecord äº§ç”Ÿèµ„æºç«äº‰

### é—®é¢˜3: âŒ çŠ¶æ€è½¬æ¢å­˜åœ¨å»¶è¿Ÿ

**ä½ç½®**: `VoiceAssistantStateProvider.kt:687-691`

```kotlin
override fun onWakeWordDetected(confidence: Float, wakeWord: String) {
    // æ›´æ–°çŠ¶æ€ä¸ºå”¤é†’æ£€æµ‹
    updateState(
        uiState = VoiceAssistantUIState.WAKE_DETECTED,
        displayText = "LISTENING",  // âŒ ç«‹å³è®¾ç½® LISTENING
        confidence = confidence
    )
    
    // çŸ­æš‚å»¶è¿Ÿåè½¬ä¸ºç›‘å¬çŠ¶æ€
    scope.launch {
        kotlinx.coroutines.delay(500)  // âŒ 500ms å»¶è¿Ÿ
        updateState(uiState = VoiceAssistantUIState.LISTENING)
    }
}
```

**é—®é¢˜**ï¼š
- `displayText` ç«‹å³è®¾ç½®ä¸º "LISTENING"
- ä½† `uiState` è¦ç­‰ 500ms åæ‰å˜ä¸º `LISTENING`
- å¦‚æœåœ¨è¿™ 500ms å†…è¶…æ—¶ï¼Œä¼šå¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´ï¼š`IDLE` + `"LISTENING"`

**å½±å“**ï¼š
æ—¥å¿—æ˜¾ç¤ºï¼š`State updated: IDLE, text: 'LISTENING'` ï¼ˆçŠ¶æ€ä¸ä¸€è‡´ï¼‰

### é—®é¢˜4: âŒ çŠ¶æ€æ›´æ–°é¡ºåºæ··ä¹±

**æ—¥å¿—åˆ†æ**ï¼š

```log
22:25:20.311  StateCoordinator: WAKE_DETECTED â†’ IDLE
22:25:20.311  StateProvider: â­ï¸ No significant state change
22:25:20.312  StateProvider: State updated: IDLE, text: 'LISTENING'
22:25:20.312  StateCoordinator: ğŸ¤ STT device loaded and ready
22:25:20.313  StateProvider: State updated: IDLE, text: ''
```

**é—®é¢˜**ï¼š
1. StateCoordinator å…ˆè½¬ä¸º IDLE
2. StateProvider è¯´ "No significant state change"ï¼ˆä½†å®é™…æœ‰å˜åŒ–ï¼‰
3. StateProvider åˆæ›´æ–°ä¸¤æ¬¡ IDLE çŠ¶æ€
4. StateCoordinator æ”¶åˆ° `Loaded` çŠ¶æ€ï¼ˆæ¥è‡ª SenseVoiceInputDeviceï¼‰

**åŸå› **ï¼š
- å¤šä¸ªç»„ä»¶åŒæ—¶æ›´æ–°çŠ¶æ€
- ç¼ºä¹ç»Ÿä¸€çš„çŠ¶æ€è½¬æ¢æ§åˆ¶
- StateProvider å’Œ StateCoordinator çš„çŠ¶æ€ä¸åŒæ­¥

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: æ­£ç¡®è®¾ç½®è¶…æ—¶åçš„çŠ¶æ€

**æ–‡ä»¶**: `SenseVoiceInputDevice.kt`

```kotlin
private suspend fun processAudio() = withContext(Dispatchers.Default) {
    try {
        // ... å¤„ç†é€»è¾‘
    } catch (e: CancellationException) {
        Log.d(TAG, "ğŸ›‘ éŸ³é¢‘å¤„ç†è¢«å–æ¶ˆ")
        withContext(Dispatchers.Main) {
            eventListener?.invoke(InputEvent.None)
        }
    } catch (e: Exception) {
        Log.e(TAG, "âŒ éŸ³é¢‘å¤„ç†å¼‚å¸¸", e)
        withContext(Dispatchers.Main) {
            eventListener?.invoke(InputEvent.Error(e))
        }
    } finally {
        isRecording.set(false)
        
        // âœ… ä¿®å¤ï¼šæ ¹æ®æƒ…å†µè®¾ç½®æ­£ç¡®çš„çŠ¶æ€
        _uiState.value = if (isInitialized.get()) {
            SttState.Idle  // å·²åˆå§‹åŒ–ï¼Œè®¾ä¸ºç©ºé—²
        } else {
            SttState.NotInitialized  // æœªåˆå§‹åŒ–
        }
        
        Log.d(TAG, "ğŸ éŸ³é¢‘å¤„ç†ç»“æŸï¼ŒçŠ¶æ€: ${_uiState.value}")
    }
}
```

### ä¿®å¤2: ç«‹å³åœæ­¢éŸ³é¢‘é‡‡é›†

**æ–‡ä»¶**: `SenseVoiceInputDevice.kt`

```kotlin
override fun stopListening() {
    if (!isRecording.get()) {
        return
    }
    
    Log.d(TAG, "ğŸ›‘ åœæ­¢è¯­éŸ³è¯†åˆ«")
    isRecording.set(false)
    
    // âœ… æ–°å¢ï¼šç«‹å³åœæ­¢AudioRecordï¼Œä¸ç­‰åç¨‹è‡ªç„¶ç»“æŸ
    audioRecord?.let {
        try {
            if (it.recordingState == AudioRecord.RECORDSTATE_RECORDING) {
                it.stop()
                Log.d(TAG, "ğŸ›‘ AudioRecordå·²åœæ­¢")
            }
        } catch (e: Exception) {
            Log.w(TAG, "åœæ­¢AudioRecordå¤±è´¥", e)
        }
    }
}
```

### ä¿®å¤3: ç§»é™¤ä¸å¿…è¦çš„å»¶è¿Ÿ

**æ–‡ä»¶**: `VoiceAssistantStateProvider.kt`

```kotlin
override fun onWakeWordDetected(confidence: Float, wakeWord: String) {
    DebugLogger.logUI(TAG, "ğŸ¯ Wake word detected: '$wakeWord' (confidence: $confidence)")
    
    // âœ… ä¿®å¤ï¼šç›´æ¥è®¾ç½®ä¸º LISTENINGï¼Œä¸éœ€è¦å»¶è¿Ÿ
    updateState(
        uiState = VoiceAssistantUIState.LISTENING,  // ç›´æ¥ LISTENING
        displayText = "LISTENING",
        confidence = confidence
    )
    
    // âŒ åˆ é™¤ï¼šä¸éœ€è¦å»¶è¿Ÿè½¬æ¢
    // scope.launch {
    //     kotlinx.coroutines.delay(500)
    //     updateState(uiState = VoiceAssistantUIState.LISTENING)
    // }
}
```

### ä¿®å¤4: ç»Ÿä¸€çŠ¶æ€è½¬æ¢é€»è¾‘

**æ–‡ä»¶**: `VoiceAssistantStateCoordinator.kt`

```kotlin
private fun handleSttStateChange(sttState: SttState?) {
    when (sttState) {
        is SttState.Loaded -> {
            DebugLogger.logUI(TAG, "ğŸ¤ STT device loaded and ready")
            // âœ… ä¿®å¤ï¼šåªåœ¨åˆé€‚çš„æ—¶å€™è½¬æ¢
            if (_uiState.value == VoiceAssistantUIState.WAKE_DETECTED) {
                // ä»å”¤é†’è½¬ä¸ºç›‘å¬
                updateUIState(VoiceAssistantUIState.LISTENING, "LISTENING")
            }
            // å…¶ä»–æƒ…å†µä¿æŒå½“å‰çŠ¶æ€
        }
        
        is SttState.Idle -> {
            DebugLogger.logUI(TAG, "ğŸ˜´ STT device idle")
            // âœ… æ–°å¢ï¼šå¤„ç† Idle çŠ¶æ€
            if (_uiState.value != VoiceAssistantUIState.IDLE) {
                updateUIState(VoiceAssistantUIState.IDLE, "")
            }
        }
        
        is SttState.Listening -> {
            DebugLogger.logUI(TAG, "ğŸ§ STT device listening")
            updateUIState(VoiceAssistantUIState.LISTENING, "LISTENING")
        }
        
        // ... å…¶ä»–çŠ¶æ€
    }
}
```

### ä¿®å¤5: å¢å¼ºçŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥

**æ–‡ä»¶**: `VoiceAssistantStateProvider.kt`

```kotlin
private fun updateState(
    uiState: VoiceAssistantUIState? = null,
    displayText: String? = null,
    confidence: Float? = null,
    asrText: String? = null,
    ttsText: String? = null,
    result: SimpleResult? = null,
    conversationHistory: List<ConversationMessage>? = null
) {
    val previousState = _currentState
    
    // âœ… æ–°å¢ï¼šçŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥
    val finalDisplayText = when {
        displayText != null -> displayText
        uiState == VoiceAssistantUIState.IDLE -> ""  // IDLE å¼ºåˆ¶æ¸…ç©ºæ–‡æœ¬
        uiState == VoiceAssistantUIState.LISTENING -> "LISTENING"
        else -> _currentState.displayText
    }
    
    _currentState = _currentState.copy(
        uiState = uiState ?: _currentState.uiState,
        displayText = finalDisplayText,
        confidence = confidence ?: _currentState.confidence,
        asrText = asrText ?: _currentState.asrText,
        ttsText = ttsText ?: _currentState.ttsText,
        result = result ?: _currentState.result,
        conversationHistory = conversationHistory ?: _currentState.conversationHistory,
        timestamp = System.currentTimeMillis()
    )
    
    // âœ… æ–°å¢ï¼šä¸€è‡´æ€§éªŒè¯
    if (_currentState.uiState == VoiceAssistantUIState.IDLE && 
        _currentState.displayText.isNotEmpty()) {
        DebugLogger.logUI(TAG, "âš ï¸ çŠ¶æ€ä¸ä¸€è‡´ï¼šIDLE ä½† displayText='${_currentState.displayText}'")
        _currentState = _currentState.copy(displayText = "")
    }
    
    // ... å…¶ä½™é€»è¾‘
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹1: å”¤é†’åè¶…æ—¶ï¼ˆæ— è¯­éŸ³ï¼‰

**æ­¥éª¤**ï¼š
1. è¯´å”¤é†’è¯
2. ä¸è¯´è¯ï¼Œç­‰å¾…è¶…æ—¶ï¼ˆ30ç§’ï¼‰

**é¢„æœŸç»“æœ**ï¼š
```log
âœ… SenseVoiceInputDevice: â° è¾¾åˆ°æœ€å¤§å½•åˆ¶æ—¶é—´
âœ… SenseVoiceInputDevice: âš ï¸ æ²¡æœ‰æœ‰æ•ˆè¯­éŸ³æ•°æ®
âœ… SenseVoiceInputDevice: ğŸ éŸ³é¢‘å¤„ç†ç»“æŸï¼ŒçŠ¶æ€: Idle
âœ… StateCoordinator: ğŸ˜´ STT device idle
âœ… StateProvider: State updated: IDLE, text: ''
âœ… DraggableFloatingOrb: UI state: IDLE
âŒ ä¸åº”è¯¥å‡ºç° "STT device loaded and ready"
âŒ ä¸åº”è¯¥ç»§ç»­é‡‡é›†éŸ³é¢‘
```

### æµ‹è¯•ç”¨ä¾‹2: å”¤é†’åç«‹å³è¶…æ—¶ï¼ˆVADå»¶è¿Ÿï¼‰

**æ­¥éª¤**ï¼š
1. è¯´å”¤é†’è¯
2. 0.5ç§’å†…ä¸è¯´è¯
3. æ£€æŸ¥çŠ¶æ€è½¬æ¢

**é¢„æœŸç»“æœ**ï¼š
```log
âœ… StateProvider: LISTENING
âœ… 6ç§’åè‡ªåŠ¨è¶…æ—¶
âœ… è½¬ä¸º IDLE
âŒ ä¸åº”è¯¥å‡ºç° "LISTENING" æ–‡æœ¬æ®‹ç•™
```

### æµ‹è¯•ç”¨ä¾‹3: æ­£å¸¸è¯­éŸ³è¯†åˆ«

**æ­¥éª¤**ï¼š
1. è¯´å”¤é†’è¯
2. è¯´è¯
3. ç­‰å¾…è¯†åˆ«å®Œæˆ

**é¢„æœŸç»“æœ**ï¼š
```log
âœ… IDLE â†’ LISTENING â†’ PROCESSING â†’ SPEAKING â†’ IDLE
âœ… æ‰€æœ‰çŠ¶æ€è½¬æ¢æ­£å¸¸
âœ… æ–‡æœ¬åŒæ­¥æ›´æ–°
```

---

## ğŸ“Š å®æ–½è®¡åˆ’

### Phase 1: ç«‹å³ä¿®å¤ï¼ˆ1-2å°æ—¶ï¼‰
- [x] ä¿®å¤1: æ­£ç¡®è®¾ç½®è¶…æ—¶åçš„çŠ¶æ€
- [x] ä¿®å¤2: ç«‹å³åœæ­¢éŸ³é¢‘é‡‡é›†
- [ ] æµ‹è¯•ç”¨ä¾‹1éªŒè¯

### Phase 2: ä¼˜åŒ–æ”¹è¿›ï¼ˆ2-3å°æ—¶ï¼‰
- [ ] ä¿®å¤3: ç§»é™¤ä¸å¿…è¦çš„å»¶è¿Ÿ
- [ ] ä¿®å¤4: ç»Ÿä¸€çŠ¶æ€è½¬æ¢é€»è¾‘
- [ ] æµ‹è¯•ç”¨ä¾‹2ã€3éªŒè¯

### Phase 3: å¢å¼ºç¨³å®šæ€§ï¼ˆ1-2å°æ—¶ï¼‰
- [ ] ä¿®å¤5: å¢å¼ºçŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥
- [ ] æ·»åŠ çŠ¶æ€ç›‘æ§æ—¥å¿—
- [ ] å…¨é¢å›å½’æµ‹è¯•

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
å”¤é†’ â†’ WAKE_DETECTED â†’ LISTENING(å»¶è¿Ÿ500ms) â†’ è¶…æ—¶ â†’ 
     â†’ Loaded âŒ â†’ IDLE(text:LISTENING) âŒ â†’ ç»§ç»­é‡‡é›† âŒ
```

### ä¿®å¤å
```
å”¤é†’ â†’ LISTENING â†’ è¶…æ—¶ â†’ Idle âœ… â†’ IDLE(text:'') âœ… â†’ åœæ­¢é‡‡é›† âœ…
```

---

## ğŸ“ é™„åŠ å»ºè®®

### 1. çŠ¶æ€æœºé‡æ„ï¼ˆé•¿æœŸï¼‰

å¼•å…¥æ­£å¼çš„çŠ¶æ€æœºæ¨¡å¼ï¼š

```kotlin
sealed class VoiceAssistantState {
    object Idle : VoiceAssistantState()
    object WakeDetected : VoiceAssistantState()
    data class Listening(val startTime: Long) : VoiceAssistantState()
    data class Processing(val text: String) : VoiceAssistantState()
    data class Speaking(val text: String) : VoiceAssistantState()
    data class Error(val throwable: Throwable) : VoiceAssistantState()
}

sealed class VoiceAssistantEvent {
    object WakeWordDetected : VoiceAssistantEvent()
    object ListeningStarted : VoiceAssistantEvent()
    object Timeout : VoiceAssistantEvent()
    data class RecognitionComplete(val text: String) : VoiceAssistantEvent()
    // ...
}

class VoiceAssistantStateMachine {
    fun transition(current: VoiceAssistantState, event: VoiceAssistantEvent): VoiceAssistantState {
        return when (current to event) {
            Idle to WakeWordDetected -> WakeDetected
            WakeDetected to ListeningStarted -> Listening(System.currentTimeMillis())
            is Listening to Timeout -> Idle  // âœ… æ¸…æ™°çš„è¶…æ—¶è½¬æ¢
            // ...
            else -> {
                Log.w(TAG, "Illegal transition: $current + $event")
                current
            }
        }
    }
}
```

### 2. èµ„æºç®¡ç†ä¼˜åŒ–

ä½¿ç”¨ Kotlin `use` æ¨¡å¼ï¼š

```kotlin
private suspend fun recordAudio() = withContext(Dispatchers.IO) {
    AudioRecord(...).use { audioRecord ->
        audioRecord.startRecording()
        
        while (isRecording.get()) {
            // é‡‡é›†é€»è¾‘
        }
        
        // AudioRecord ä¼šè‡ªåŠ¨é‡Šæ”¾
    }
}
```

### 3. è¶…æ—¶ç®¡ç†ç»Ÿä¸€

```kotlin
class TimeoutController {
    private val handler = Handler(Looper.getMainLooper())
    private val timeouts = ConcurrentHashMap<String, Runnable>()
    
    fun setTimeout(name: String, delayMs: Long, action: () -> Unit) {
        cancel(name)
        val runnable = Runnable {
            timeouts.remove(name)
            action()
        }
        timeouts[name] = runnable
        handler.postDelayed(runnable, delayMs)
    }
    
    fun cancel(name: String) {
        timeouts.remove(name)?.let { handler.removeCallbacks(it) }
    }
}

// ä½¿ç”¨
timeoutController.setTimeout("asr_silence", 6000) {
    handleSilenceTimeout()
}
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [è¯­éŸ³åŠ©æ‰‹çŠ¶æ€è½¬æ¢ä¸Bufferå¤„ç†å®Œæ•´è®¾è®¡](./è¯­éŸ³åŠ©æ‰‹çŠ¶æ€è½¬æ¢ä¸Bufferå¤„ç†å®Œæ•´è®¾è®¡.md)
- [æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ-æ„å›¾è¯†åˆ«ä¸å‘½ä»¤æ‰§è¡Œ](./æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ-æ„å›¾è¯†åˆ«ä¸å‘½ä»¤æ‰§è¡Œ.md)

---

**æ–‡æ¡£ç»“æŸ**

