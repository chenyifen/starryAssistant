# Dicio 预打包模型使用指南

## 概述

本指南说明如何将语音识别和唤醒词检测模型预打包到APK中，避免用户在首次使用时需要手动下载模型文件。

## 已完成的工作

### 1. 模型文件下载与组织

#### OpenWakeWord 模型文件
已下载并放置在 `app/src/main/assets/models/openWakeWord/` 目录：
- `melspectrogram.tflite` (1.1MB) - Mel频谱图处理模型
- `embedding.tflite` (1.3MB) - 特征嵌入模型  
- `wake.tflite` (201KB) - "Hey Dicio"唤醒词检测模型

#### Vosk 语音识别模型
已下载并放置在 `app/src/main/assets/models/vosk/` 目录：
- `cn/` - 中文语音识别模型 (约42MB解压后)
- `en/` - 英语语音识别模型 (约39MB解压后)  
- `ko/` - 韩语语音识别模型 (约83MB解压后)

### 2. 代码修改

#### 新增 AssetModelManager 工具类
- **文件**: `app/src/main/kotlin/org/stypox/dicio/util/AssetModelManager.kt`
- **功能**: 管理从assets目录复制模型文件到应用数据目录
- **主要方法**:
  - `copyOpenWakeWordModels()` - 复制OpenWakeWord模型
  - `copyVoskModel()` - 复制指定语言的Vosk模型
  - `hasVoskModelInAssets()` - 检查assets中是否存在指定语言模型
  - `hasOpenWakeWordModelsInAssets()` - 检查assets中是否存在OpenWakeWord模型

#### 修改 OpenWakeWordDevice
- 在初始化时检查assets中是否有预打包模型
- 在download()方法中优先从assets复制模型，失败时才从网络下载
- 支持无缝回退到原有的网络下载机制

#### 修改 VoskInputDevice  
- 在init()方法中检查assets中是否有对应语言的模型
- 在unzip()方法中优先从assets复制模型，失败时才解压zip文件
- 支持动态语言切换时的模型管理

## 工作原理

### 1. 模型检测流程
```
应用启动 → 检查本地文件系统 → 检查assets目录 → 确定模型状态
```

### 2. 模型加载优先级
1. **本地文件系统** - 如果用户已下载模型，直接使用
2. **Assets目录** - 如果assets中有预打包模型，复制到本地
3. **网络下载** - 如果以上都不可用，从网络下载

### 3. 语言切换处理
- 检测到语言变更时，自动检查assets中是否有对应语言模型
- 如果有，复制新语言模型并清理旧模型
- 如果没有，回退到网络下载机制

## 构建配置

### Assets 目录结构
```
app/src/main/assets/models/
├── openWakeWord/
│   ├── embedding.tflite
│   ├── melspectrogram.tflite
│   └── wake.tflite
└── vosk/
    ├── cn/
    │   ├── am/final.mdl
    │   ├── conf/
    │   ├── graph/
    │   └── ivector/
    ├── en/
    │   ├── am/final.mdl
    │   ├── conf/
    │   ├── graph/
    │   └── ivector/
    └── ko/
        ├── am/final.mdl
        ├── conf/
        ├── graph/
        └── ivector/
```

### APK 大小影响
- OpenWakeWord模型: ~2.6MB
- Vosk模型 (3种语言): ~164MB
- **总增加**: ~167MB

## 用户体验改进

### 1. 首次启动体验
- ✅ 无需等待模型下载
- ✅ 立即可用语音功能
- ✅ 无需网络连接

### 2. 语言切换体验  
- ✅ 支持的语言(中/英/韩)可立即切换
- ✅ 不支持的语言自动回退到下载模式
- ✅ 智能缓存管理避免重复下载

### 3. 离线使用
- ✅ 完全离线语音识别
- ✅ 完全离线唤醒词检测
- ✅ 适合网络受限环境

## 开发者指南

### 添加新语言模型

1. **下载模型文件**:
```bash
cd app/src/main/assets/models/vosk
curl -L -o vosk-model-small-{lang}-{version}.zip "{model_url}"
unzip vosk-model-small-{lang}-{version}.zip
mv vosk-model-small-{lang}-{version} {lang}
rm vosk-model-small-{lang}-{version}.zip
```

2. **无需修改代码** - AssetModelManager会自动检测新增的语言模型

### 更新现有模型

1. **替换模型文件** - 直接替换assets目录中的对应文件
2. **清理用户缓存** - 用户需要清除应用数据或重新安装

### 构建优化建议

#### 多APK构建 (推荐)
可以考虑为不同语言创建不同的APK变体：
```gradle
android {
    splits {
        density {
            enable false
        }
        abi {
            enable false  
        }
    }
}

// 自定义构建变体
flavorDimensions "language"
productFlavors {
    chinese {
        dimension "language"
        // 只包含中文模型
    }
    english {
        dimension "language"
        // 只包含英文模型
    }
    korean {
        dimension "language"
        // 只包含韩文模型
    }
    full {
        dimension "language"
        // 包含所有模型
    }
}
```

#### 动态功能模块
使用Android App Bundle的动态功能模块：
```gradle
// 在单独的模块中定义语言包
dynamicFeatures = [":feature-chinese", ":feature-korean"]
```

## 测试验证

### 1. 功能测试
- [x] OpenWakeWord模型从assets正确复制
- [x] Vosk模型从assets正确复制  
- [x] 语言切换时模型正确更新
- [x] 网络下载回退机制正常工作

### 2. 性能测试
- [ ] 首次启动时间对比
- [ ] 模型复制耗时测量
- [ ] 内存使用情况监控
- [ ] 存储空间占用分析

### 3. 兼容性测试
- [ ] 不同Android版本兼容性
- [ ] 不同设备架构兼容性  
- [ ] 升级场景兼容性测试

## 注意事项

### 1. 存储空间
- 预打包模型会显著增加APK大小
- 建议在应用描述中说明存储需求
- 考虑提供"精简版"不包含模型的APK

### 2. 更新策略
- 模型文件更新需要发布新版本APK
- 考虑实现模型版本检查和增量更新
- 保持与原有网络下载机制的兼容性

### 3. 许可证合规
- 确保所有预打包模型的许可证兼容
- 在应用中显示相关许可证信息
- 遵守第三方模型的使用条款

## 未来改进

### 1. 智能模型管理
- 根据用户使用习惯动态下载模型
- 实现模型使用统计和优化建议
- 支持模型压缩和优化技术

### 2. 云端模型服务
- 提供可选的云端语音识别服务
- 实现本地/云端混合模式
- 支持实时模型更新推送

### 3. 用户自定义
- 允许用户选择需要的语言包
- 支持用户上传自定义模型
- 提供模型管理界面

## 总结

通过预打包模型文件，Dicio应用现在可以为中文、英语和韩语用户提供开箱即用的语音识别体验。这一改进显著提升了用户体验，特别是在网络受限或首次使用的场景下。

代码修改采用了向后兼容的设计，确保现有的网络下载机制仍然可用，为不支持的语言提供了优雅的回退方案。
