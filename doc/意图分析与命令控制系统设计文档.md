# Dicioè¯­éŸ³åŠ©æ‰‹æ„å›¾åˆ†æä¸å‘½ä»¤æ§åˆ¶ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [æ„å›¾è¯†åˆ«æµç¨‹](#æ„å›¾è¯†åˆ«æµç¨‹)
4. [æŠ€èƒ½ç³»ç»Ÿ](#æŠ€èƒ½ç³»ç»Ÿ)
5. [å¥å­æ¨¡å¼åŒ¹é…](#å¥å­æ¨¡å¼åŒ¹é…)
6. [è¯„åˆ†ä¸æ’åºæœºåˆ¶](#è¯„åˆ†ä¸æ’åºæœºåˆ¶)
7. [å¤šè½®å¯¹è¯ç®¡ç†](#å¤šè½®å¯¹è¯ç®¡ç†)
8. [æŠ€èƒ½æ‰§è¡Œæµç¨‹](#æŠ€èƒ½æ‰§è¡Œæµç¨‹)
9. [æ‰©å±•ä¸å®šåˆ¶](#æ‰©å±•ä¸å®šåˆ¶)
10. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## ç³»ç»Ÿæ¦‚è¿°

Dicioè¯­éŸ³åŠ©æ‰‹é‡‡ç”¨åŸºäº**æŠ€èƒ½(Skill)**çš„æ„å›¾åˆ†æå’Œå‘½ä»¤æ§åˆ¶ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿé€šè¿‡**å¥å­æ¨¡å¼åŒ¹é…**ã€**è¯„åˆ†æ’åº**å’Œ**å¤šè½®å¯¹è¯ç®¡ç†**æ¥å®ç°ç²¾ç¡®çš„è¯­éŸ³å‘½ä»¤è¯†åˆ«å’Œæ‰§è¡Œã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§
- **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒ13ç§è¯­è¨€çš„å¥å­æ¨¡å¼
- **åˆ†å±‚è¯„åˆ†**: åŸºäºä¼˜å…ˆçº§çš„ä¸‰è½®è¯„åˆ†æœºåˆ¶
- **å¤šè½®å¯¹è¯**: æ”¯æŒä¸Šä¸‹æ–‡ç›¸å…³çš„è¿ç»­äº¤äº’
- **å¯æ‰©å±•æ¶æ„**: æ’ä»¶åŒ–çš„æŠ€èƒ½ç³»ç»Ÿ
- **å®æ—¶å¤„ç†**: æ”¯æŒéƒ¨åˆ†è¯†åˆ«ç»“æœçš„å®æ—¶å¤„ç†

---

## æ ¸å¿ƒæ¶æ„

### ğŸ—ï¸ ä¸»è¦ç»„ä»¶

```mermaid
graph TB
    A[ASRè¾“å…¥] --> B[SkillEvaluator]
    B --> C[SkillHandler]
    C --> D[SkillRanker]
    D --> E[æŠ€èƒ½åŒ¹é…]
    E --> F[æŠ€èƒ½æ‰§è¡Œ]
    F --> G[TTSè¾“å‡º]
    
    H[å¥å­æ¨¡å¼åº“] --> D
    I[æŠ€èƒ½å®šä¹‰] --> C
    J[å¤šè½®å¯¹è¯ç®¡ç†] --> B
```

### ğŸ“¦ æ ¸å¿ƒç±»ç»“æ„

#### 1. SkillEvaluator (æŠ€èƒ½è¯„ä¼°å™¨)
```kotlin
interface SkillEvaluator {
    val state: StateFlow<InteractionLog>
    val inputEvents: SharedFlow<InputEvent>
    var permissionRequester: suspend (List<Permission>) -> Boolean
    fun processInputEvent(event: InputEvent)
}
```

**èŒè´£**:
- å¤„ç†ASRè¾“å…¥äº‹ä»¶ (Partial, Final, Error, None)
- ç®¡ç†äº¤äº’çŠ¶æ€å’Œå¯¹è¯å†å²
- åè°ƒæŠ€èƒ½åŒ¹é…å’Œæ‰§è¡Œæµç¨‹
- å¤„ç†æƒé™è¯·æ±‚

#### 2. SkillHandler (æŠ€èƒ½å¤„ç†å™¨)
```kotlin
@Singleton
class SkillHandler {
    val allSkillInfoList: List<SkillInfo>
    val enabledSkillsInfo: StateFlow<List<SkillInfo>?>
    val skillRanker: StateFlow<SkillRanker>
}
```

**èŒè´£**:
- ç®¡ç†æ‰€æœ‰å¯ç”¨æŠ€èƒ½
- æ ¹æ®ç”¨æˆ·è®¾ç½®è¿‡æ»¤å¯ç”¨çš„æŠ€èƒ½
- åˆ›å»ºå’Œç»´æŠ¤SkillRankerå®ä¾‹
- å¤„ç†æŠ€èƒ½çš„ç”Ÿå‘½å‘¨æœŸ

#### 3. SkillRanker (æŠ€èƒ½æ’åºå™¨)
```kotlin
class SkillRanker(
    defaultSkillBatch: List<Skill<*>>,
    private var fallbackSkill: Skill<*>
) {
    fun getBest(ctx: SkillContext, input: String): SkillWithResult<*>?
    fun getFallbackSkill(ctx: SkillContext, input: String): SkillWithResult<*>
}
```

**èŒè´£**:
- å®ç°ä¸‰è½®è¯„åˆ†æœºåˆ¶
- ç®¡ç†æŠ€èƒ½ä¼˜å…ˆçº§ (HIGH, MEDIUM, LOW)
- å¤„ç†å¤šè½®å¯¹è¯çš„æŠ€èƒ½æ ˆ
- æä¾›fallbackæŠ€èƒ½

---

## æ„å›¾è¯†åˆ«æµç¨‹

### ğŸ”„ å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant ASR as ASRè®¾å¤‡
    participant SE as SkillEvaluator
    participant SR as SkillRanker
    participant S as Skill
    participant TTS as TTSè®¾å¤‡

    ASR->>SE: InputEvent.Partial("å¤©æ°”")
    SE->>SE: æ›´æ–°pendingQuestion
    
    ASR->>SE: InputEvent.Final([("å¤©æ°”æ€ä¹ˆæ ·", 0.95)])
    SE->>SR: getBest(ctx, "å¤©æ°”æ€ä¹ˆæ ·")
    SR->>S: score(ctx, "å¤©æ°”æ€ä¹ˆæ ·")
    S-->>SR: (Score, InputData)
    SR-->>SE: SkillWithResult
    
    SE->>S: generateOutput(ctx, inputData)
    S-->>SE: SkillOutput
    SE->>TTS: speak(speechOutput)
```

### ğŸ“ è¾“å…¥äº‹ä»¶ç±»å‹

#### InputEvent.Partial
```kotlin
// éƒ¨åˆ†è¯†åˆ«ç»“æœï¼Œç”¨äºå®æ—¶æ˜¾ç¤º
InputEvent.Partial(utterance: String)
```

#### InputEvent.Final  
```kotlin
// æœ€ç»ˆè¯†åˆ«ç»“æœï¼ŒåŒ…å«å¤šä¸ªå€™é€‰å’Œç½®ä¿¡åº¦
InputEvent.Final(utterances: List<Pair<String, Float>>)
```

#### InputEvent.Error
```kotlin
// è¯†åˆ«é”™è¯¯
InputEvent.Error(throwable: Throwable)
```

#### InputEvent.None
```kotlin
// æ— è¾“å…¥æˆ–å–æ¶ˆ
InputEvent.None
```

---

## æŠ€èƒ½ç³»ç»Ÿ

### ğŸ› ï¸ å†…ç½®æŠ€èƒ½åˆ—è¡¨

| æŠ€èƒ½ID | ä¼˜å…ˆçº§ | åŠŸèƒ½æè¿° | ç¤ºä¾‹å‘½ä»¤ |
|--------|--------|----------|----------|
| weather | HIGH | å¤©æ°”æŸ¥è¯¢ | "å¤©æ°”æ€ä¹ˆæ ·", "åŒ—äº¬çš„å¤©æ°”" |
| current_time | HIGH | æ—¶é—´æŸ¥è¯¢ | "ç°åœ¨å‡ ç‚¹", "ä»Šå¤©æ˜¯å‡ å·" |
| timer | HIGH | å®šæ—¶å™¨ç®¡ç† | "è®¾ç½®5åˆ†é’Ÿå®šæ—¶å™¨", "å–æ¶ˆå®šæ—¶å™¨" |
| media | HIGH | åª’ä½“æ§åˆ¶ | "æ’­æ”¾éŸ³ä¹", "æš‚åœ", "ä¸‹ä¸€é¦–" |
| listening | HIGH | è¯­éŸ³æ§åˆ¶ | "åœæ­¢ç›‘å¬", "å¼€å§‹ç›‘å¬" |
| lyrics | HIGH | æ­Œè¯æŸ¥è¯¢ | "å‘¨æ°ä¼¦ç¨»é¦™çš„æ­Œè¯" |
| navigation | HIGH | å¯¼èˆªæŸ¥è¯¢ | "å»åŒ—äº¬å¤§å­¦æ€ä¹ˆèµ°" |
| calculator | MEDIUM | è®¡ç®—å™¨ | "3åŠ 5ç­‰äºå¤šå°‘" |
| open | MEDIUM | åº”ç”¨å¯åŠ¨ | "æ‰“å¼€å¾®ä¿¡", "å¯åŠ¨ç›¸æœº" |
| telephone | LOW | ç”µè¯æ‹¨æ‰“ | "ç»™å¼ ä¸‰æ‰“ç”µè¯" |
| search | LOW | ç½‘ç»œæœç´¢ | "æœç´¢äººå·¥æ™ºèƒ½" |

### ğŸ—ï¸ æŠ€èƒ½å®šä¹‰ç»“æ„

#### SkillInfo (æŠ€èƒ½ä¿¡æ¯)
```kotlin
abstract class SkillInfo(val id: String) {
    abstract fun name(context: Context): String
    abstract fun sentenceExample(context: Context): String
    abstract fun isAvailable(ctx: SkillContext): Boolean
    abstract fun build(ctx: SkillContext): Skill<*>
    
    @Composable
    abstract fun icon(): Painter
    
    open val renderSettings: @Composable () -> Unit = {}
    open val neededPermissions: List<Permission> = listOf()
}
```

#### Skill (æŠ€èƒ½å®ç°)
```kotlin
abstract class Skill<InputData>(
    val correspondingSkillInfo: SkillInfo,
    val specificity: Specificity
) {
    abstract suspend fun score(ctx: SkillContext, input: String): Pair<Score, InputData>
    abstract suspend fun generateOutput(ctx: SkillContext, inputData: InputData): SkillOutput
}
```

### ğŸ“‹ æŠ€èƒ½ç¤ºä¾‹: WeatherSkill

```kotlin
class WeatherSkill(
    correspondingSkillInfo: SkillInfo, 
    data: StandardRecognizerData<Weather>
) : StandardRecognizerSkill<Weather>(correspondingSkillInfo, data) {

    override suspend fun generateOutput(ctx: SkillContext, inputData: Weather): SkillOutput {
        val prefs = ctx.android.weatherDataStore.data.first()
        val city = getCity(prefs, inputData) ?: return WeatherOutput.Failed(city = "")
        
        val weatherData = ConnectionUtils.getPageJson(
            "$WEATHER_API_URL?APPID=$API_KEY&units=metric&lang=" +
            ctx.locale.language.lowercase() + "&q=" + ConnectionUtils.urlEncode(city)
        )
        
        return WeatherOutput.Success(
            city = weatherData.getString("name"),
            description = weatherObject.getString("description"),
            temp = mainObject.getDouble("temp"),
            // ... å…¶ä»–å¤©æ°”æ•°æ®
        )
    }
}
```

---

## å¥å­æ¨¡å¼åŒ¹é…

### ğŸ“ å¥å­å®šä¹‰ç»“æ„

```
app/src/main/sentences/
â”œâ”€â”€ skill_definitions.yml    # æŠ€èƒ½å®šä¹‰å’Œç»“æ„
â”œâ”€â”€ cn/                     # ä¸­æ–‡å¥å­æ¨¡å¼
â”‚   â”œâ”€â”€ weather.yml
â”‚   â”œâ”€â”€ calculator.yml
â”‚   â””â”€â”€ ...
â”œâ”€â”€ en/                     # è‹±æ–‡å¥å­æ¨¡å¼  
â”‚   â”œâ”€â”€ weather.yml
â”‚   â””â”€â”€ ...
â””â”€â”€ [å…¶ä»–è¯­è¨€]/
```

### ğŸ”§ æŠ€èƒ½å®šä¹‰æ ¼å¼

```yaml
# skill_definitions.yml
skills:
  - id: weather
    specificity: high
    sentences:
      - id: current
        captures:
          - id: where
            type: string
```

### ğŸŒ å¥å­æ¨¡å¼ç¤ºä¾‹

#### ä¸­æ–‡å¤©æ°”æ¨¡å¼ (cn/weather.yml)
```yaml
current:
  - å¤©æ°”æ€ä¹ˆæ ·
  - å¤©æ°” æ€ä¹ˆæ ·
  - ä»Šå¤©å¤©æ°”å¦‚ä½•
  - (.where.)çš„å¤©æ°”æ€ä¹ˆæ ·
  - (.where.) çš„ å¤©æ°” æ€ä¹ˆæ ·
  - å¤–é¢å†·å—
  - ä¼šä¸‹é›¨å—
  - å¤©æ°”
  - æŸ¥è¯¢å¤©æ°”
```

#### è‹±æ–‡å¤©æ°”æ¨¡å¼ (en/weather.yml)
```yaml
current:
  - (what is|s)|whats the weather like? (in|on .where.)?
  - weather (in|on? .where.)?
  - how is it outside
  - is it cold|cool|warm|hot|sunny|rainy|raining (in|on .where.)|outside?
```

### ğŸ¯ æ¨¡å¼åŒ¹é…ç‰¹æ€§

#### 1. å‚æ•°æ•è·
- `(.where.)`: æ•è·åœ°ç‚¹å‚æ•°
- `(.duration.)`: æ•è·æ—¶é—´å‚æ•°
- `(.what.)`: æ•è·é€šç”¨å­—ç¬¦ä¸²å‚æ•°

#### 2. å¯é€‰åŒ¹é…
- `(word1|word2)`: é€‰æ‹©åŒ¹é…
- `word?`: å¯é€‰å•è¯
- `(phrase)?`: å¯é€‰çŸ­è¯­

#### 3. åˆ†è¯å¤„ç†
- æ”¯æŒç©ºæ ¼åˆ†è¯: `å¤©æ°” æ€ä¹ˆæ ·`
- æ”¯æŒè¿ç»­åŒ¹é…: `å¤©æ°”æ€ä¹ˆæ ·`

---

## è¯„åˆ†ä¸æ’åºæœºåˆ¶

### ğŸ† ä¸‰è½®è¯„åˆ†ç³»ç»Ÿ

SkillRankeré‡‡ç”¨åˆ†å±‚è¯„åˆ†æœºåˆ¶ï¼Œç¡®ä¿é«˜ä¼˜å…ˆçº§æŠ€èƒ½ä¼˜å…ˆåŒ¹é…ï¼š

#### ç¬¬ä¸€è½®: é«˜ä¼˜å…ˆçº§æŠ€èƒ½ (HIGH)
- **é˜ˆå€¼**: 0.85
- **ç­–ç•¥**: åªè€ƒè™‘HIGHä¼˜å…ˆçº§æŠ€èƒ½
- **ç›®æ ‡**: å¿«é€ŸåŒ¹é…æ˜ç¡®çš„é«˜ä¼˜å…ˆçº§å‘½ä»¤

#### ç¬¬äºŒè½®: ä¸­ç­‰ä¼˜å…ˆçº§æŠ€èƒ½ (MEDIUM + HIGH)
- **MEDIUMé˜ˆå€¼**: 0.90
- **HIGHé˜ˆå€¼**: 0.80 (é™ä½)
- **ç­–ç•¥**: åŒæ—¶è€ƒè™‘MEDIUMå’ŒHIGHæŠ€èƒ½
- **ç›®æ ‡**: åœ¨é«˜ä¼˜å…ˆçº§æŠ€èƒ½æœªåŒ¹é…æ—¶ï¼Œå°è¯•ä¸­ç­‰ä¼˜å…ˆçº§

#### ç¬¬ä¸‰è½®: æ‰€æœ‰æŠ€èƒ½ (LOW + MEDIUM + HIGH)
- **LOWé˜ˆå€¼**: 0.90
- **MEDIUMé˜ˆå€¼**: 0.80 (é™ä½)
- **HIGHé˜ˆå€¼**: 0.70 (è¿›ä¸€æ­¥é™ä½)
- **ç­–ç•¥**: è€ƒè™‘æ‰€æœ‰æŠ€èƒ½
- **ç›®æ ‡**: æœ€å¤§åŒ–åŒ¹é…å¯èƒ½æ€§

### ğŸ“Š è¯„åˆ†å®ç°ç¤ºä¾‹

```kotlin
private fun getBest(ctx: SkillContext, input: String): SkillWithResult<*>? {
    Log.d(TAG, "ğŸ¯ å¼€å§‹è¯„ä¼°è¾“å…¥: '$input'")
    
    // ç¬¬ä¸€è½®: HIGHæŠ€èƒ½
    val bestHigh = getBestForSpecificity(ctx, highSkills, input)
    if (bestHigh != null && bestHigh.score.scoreIn01Range() > HIGH_THRESHOLD_1) {
        return bestHigh
    }
    
    // ç¬¬äºŒè½®: MEDIUM + HIGHæŠ€èƒ½
    val bestMedium = getBestForSpecificity(ctx, mediumSkills, input)
    if (bestMedium != null && bestMedium.score.scoreIn01Range() > MEDIUM_THRESHOLD_2) {
        return bestMedium
    } else if (bestHigh != null && bestHigh.score.scoreIn01Range() > HIGH_THRESHOLD_2) {
        return bestHigh
    }
    
    // ç¬¬ä¸‰è½®: æ‰€æœ‰æŠ€èƒ½
    val bestLow = getBestForSpecificity(ctx, lowSkills, input)
    if (bestLow != null && bestLow.score.scoreIn01Range() > LOW_THRESHOLD_3) {
        return bestLow
    } else if (bestMedium != null && bestMedium.score.scoreIn01Range() > MEDIUM_THRESHOLD_3) {
        return bestMedium
    } else if (bestHigh != null && bestHigh.score.scoreIn01Range() > HIGH_THRESHOLD_3) {
        return bestHigh
    }
    
    return null // ä½¿ç”¨fallbackæŠ€èƒ½
}
```

---

## å¤šè½®å¯¹è¯ç®¡ç†

### ğŸ”„ å¯¹è¯çŠ¶æ€ç®¡ç†

Dicioæ”¯æŒåŸºäºæŠ€èƒ½æ ˆçš„å¤šè½®å¯¹è¯ï¼š

#### InteractionPlan (äº¤äº’è®¡åˆ’)
```kotlin
sealed class InteractionPlan {
    object FinishInteraction : InteractionPlan()
    object FinishSubInteraction : InteractionPlan()
    object Continue : InteractionPlan()
    data class StartSubInteraction(val nextSkills: List<Skill<*>>) : InteractionPlan()
    data class ReplaceSubInteraction(val nextSkills: List<Skill<*>>) : InteractionPlan()
}
```

#### å¯¹è¯æµç¨‹æ§åˆ¶
```kotlin
when (interactionPlan) {
    InteractionPlan.FinishInteraction -> {
        // ç»“æŸæ•´ä¸ªå¯¹è¯ï¼Œé‡ç½®åˆ°é»˜è®¤æŠ€èƒ½é›†
        skillRanker.removeAllBatches()
    }
    is InteractionPlan.FinishSubInteraction -> {
        // ç»“æŸå­å¯¹è¯ï¼Œè¿”å›ä¸Šä¸€çº§
        skillRanker.removeTopBatch()
    }
    is InteractionPlan.Continue -> {
        // ç»§ç»­å½“å‰å¯¹è¯ï¼Œä¿æŒæŠ€èƒ½æ ˆä¸å˜
    }
    is InteractionPlan.StartSubInteraction -> {
        // å¼€å§‹å­å¯¹è¯ï¼Œæ¨å…¥æ–°çš„æŠ€èƒ½é›†
        skillRanker.addBatchToTop(interactionPlan.nextSkills)
    }
    is InteractionPlan.ReplaceSubInteraction -> {
        // æ›¿æ¢å½“å‰å­å¯¹è¯
        skillRanker.removeTopBatch()
        skillRanker.addBatchToTop(interactionPlan.nextSkills)
    }
}
```

### ğŸ“ å¤šè½®å¯¹è¯ç¤ºä¾‹: ç”µè¯æŠ€èƒ½

```kotlin
// ç”¨æˆ·: "ç»™å¼ ä¸‰æ‰“ç”µè¯"
// ç³»ç»Ÿ: "æ‰¾åˆ°3ä¸ªå¼ ä¸‰ï¼Œè¯·é€‰æ‹©ï¼š1. å¼ ä¸‰(æœ‹å‹) 2. å¼ ä¸‰(åŒäº‹) 3. å¼ ä¸‰(å®¶äºº)"
// ç”¨æˆ·: "ç¬¬ä¸€ä¸ª"
// ç³»ç»Ÿ: "æ­£åœ¨æ‹¨æ‰“å¼ ä¸‰(æœ‹å‹)çš„ç”µè¯..."

class TelephoneSkill : Skill<TelephoneData> {
    override suspend fun generateOutput(ctx: SkillContext, inputData: TelephoneData): SkillOutput {
        return when (inputData) {
            is TelephoneData.Dial -> {
                val contacts = findContacts(inputData.who)
                if (contacts.size > 1) {
                    // è¿”å›é€‰æ‹©ç•Œé¢ï¼Œå¼€å§‹å­å¯¹è¯
                    ContactChooserOutput(contacts).apply {
                        interactionPlan = InteractionPlan.StartSubInteraction(
                            listOf(ContactChooserSkill(contacts))
                        )
                    }
                } else {
                    // ç›´æ¥æ‹¨æ‰“
                    makeCall(contacts.first())
                }
            }
        }
    }
}
```

---

## æŠ€èƒ½æ‰§è¡Œæµç¨‹

### âš¡ æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant SE as SkillEvaluator
    participant S as Skill
    participant SO as SkillOutput
    participant TTS as TTS

    U->>SE: "å¤©æ°”æ€ä¹ˆæ ·"
    SE->>SE: evaluateMatchingSkill()
    SE->>S: score(ctx, input)
    S-->>SE: (Score, InputData)
    SE->>S: generateOutput(ctx, inputData)
    
    alt éœ€è¦æƒé™
        S-->>SE: æ£€æŸ¥æƒé™
        SE->>U: è¯·æ±‚æƒé™
        U-->>SE: æˆæƒç»“æœ
    end
    
    S-->>SE: SkillOutput
    SE->>SO: getSpeechOutput()
    SO-->>SE: "ä»Šå¤©åŒ—äº¬æ™´ï¼Œæ¸©åº¦25åº¦"
    SE->>TTS: speak(speechOutput)
    
    alt éœ€è¦é‡æ–°å¼€å¯éº¦å…‹é£
        SE->>SE: ç­‰å¾…TTSå®Œæˆ
        SE->>SE: é‡æ–°å¼€å¯STT
    end
```

### ğŸ”§ æŠ€èƒ½è¾“å‡ºå¤„ç†

```kotlin
private suspend fun evaluateMatchingSkill(utterances: List<String>) {
    val (chosenInput, chosenSkill) = findBestSkill(utterances)
    
    try {
        // 1. æƒé™æ£€æŸ¥
        val permissions = chosenSkill.skill.correspondingSkillInfo.neededPermissions
        if (permissions.isNotEmpty() && !permissionRequester(permissions)) {
            addInteractionFromPending(MissingPermissionsSkillOutput(skillInfo))
            return
        }
        
        // 2. è®¾ç½®ä¸Šä¸‹æ–‡
        skillContext.previousOutput = getLastInteractionOutput()
        
        // 3. ç”Ÿæˆè¾“å‡º
        val output = chosenSkill.generateOutput(skillContext)
        val interactionPlan = output.getInteractionPlan(skillContext)
        
        // 4. æ·»åŠ åˆ°äº¤äº’å†å²
        addInteractionFromPending(output)
        
        // 5. TTSæ’­æ”¾
        output.getSpeechOutput(skillContext).let { speechText ->
            if (speechText.isNotBlank()) {
                skillContext.speechOutputDevice.speak(speechText)
            }
        }
        
        // 6. å¤„ç†äº¤äº’è®¡åˆ’
        handleInteractionPlan(interactionPlan)
        
        // 7. é‡æ–°å¼€å¯éº¦å…‹é£ (å¦‚æœéœ€è¦)
        if (interactionPlan.reopenMicrophone) {
            skillContext.speechOutputDevice.runWhenFinishedSpeaking {
                sttInputDevice.tryLoad(this::processInputEvent)
            }
        }
        
    } catch (throwable: Throwable) {
        addErrorInteractionFromPending(throwable)
    }
}
```

---

## æ‰©å±•ä¸å®šåˆ¶

### ğŸ”Œ æ·»åŠ æ–°æŠ€èƒ½

#### 1. åˆ›å»ºæŠ€èƒ½å®šä¹‰
```kotlin
object CustomSkillInfo : SkillInfo("custom_skill") {
    override fun name(context: Context) = "è‡ªå®šä¹‰æŠ€èƒ½"
    override fun sentenceExample(context: Context) = "æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤"
    override fun isAvailable(ctx: SkillContext): Boolean = true
    override fun build(ctx: SkillContext): Skill<*> = CustomSkill(this, sentences)
}
```

#### 2. å®ç°æŠ€èƒ½é€»è¾‘
```kotlin
class CustomSkill(
    correspondingSkillInfo: SkillInfo,
    data: StandardRecognizerData<CustomData>
) : StandardRecognizerSkill<CustomData>(correspondingSkillInfo, data) {

    override suspend fun generateOutput(ctx: SkillContext, inputData: CustomData): SkillOutput {
        return when (inputData) {
            is CustomData.Action -> {
                // æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
                performCustomAction(inputData.params)
                CustomSkillOutput.Success("æ“ä½œå®Œæˆ")
            }
        }
    }
}
```

#### 3. æ·»åŠ å¥å­æ¨¡å¼
```yaml
# skill_definitions.yml
- id: custom_skill
  specificity: medium
  sentences:
    - id: action
      captures:
        - id: params
          type: string
```

```yaml
# cn/custom_skill.yml
action:
  - æ‰§è¡Œ(.params.)
  - è¿è¡Œ(.params.)
  - å¯åŠ¨(.params.)
```

#### 4. æ³¨å†ŒæŠ€èƒ½
```kotlin
// åœ¨SkillHandlerä¸­æ·»åŠ 
val allSkillInfoList = listOf(
    WeatherInfo,
    SearchInfo,
    // ... å…¶ä»–æŠ€èƒ½
    CustomSkillInfo, // æ·»åŠ æ–°æŠ€èƒ½
)
```

### ğŸŒ æ·»åŠ æ–°è¯­è¨€æ”¯æŒ

#### 1. åˆ›å»ºè¯­è¨€ç›®å½•
```
app/src/main/sentences/
â””â”€â”€ [æ–°è¯­è¨€ä»£ç ]/
    â”œâ”€â”€ weather.yml
    â”œâ”€â”€ calculator.yml
    â””â”€â”€ ...
```

#### 2. ç¿»è¯‘å¥å­æ¨¡å¼
```yaml
# ja/weather.yml (æ—¥è¯­ç¤ºä¾‹)
current:
  - å¤©æ°—ã¯ã©ã†ã§ã™ã‹
  - ä»Šæ—¥ã®å¤©æ°—ã¯
  - (.where.)ã®å¤©æ°—
  - å¤–ã¯å¯’ã„ã§ã™ã‹
```

#### 3. æ›´æ–°æœ¬åœ°åŒ–èµ„æº
```xml
<!-- res/values-ja/strings.xml -->
<string name="skill_name_weather">å¤©æ°—</string>
<string name="skill_sentence_example_weather">å¤©æ°—ã¯ã©ã†ã§ã™ã‹</string>
```

---

## æ€§èƒ½ä¼˜åŒ–

### âš¡ å…³é”®ä¼˜åŒ–ç­–ç•¥

#### 1. å¥å­ç¼–è¯‘ç¼“å­˜
- ä½¿ç”¨KSPç¼–è¯‘æ—¶ç”Ÿæˆå¥å­åŒ¹é…ä»£ç 
- é¿å…è¿è¡Œæ—¶è§£æYAMLæ–‡ä»¶
- é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼

#### 2. æŠ€èƒ½æ‡’åŠ è½½
```kotlin
class SkillHandler {
    private val skillCache = mutableMapOf<String, Skill<*>>()
    
    private fun buildSkillFromInfo(skillInfo: SkillInfo): Skill<*> {
        return skillCache.getOrPut(skillInfo.id) {
            skillInfo.build(skillContext)
        }
    }
}
```

#### 3. è¯„åˆ†ä¼˜åŒ–
- ä¸‰è½®è¯„åˆ†æœºåˆ¶é¿å…ä¸å¿…è¦çš„è®¡ç®—
- æ—©æœŸé€€å‡ºç­–ç•¥
- æŠ€èƒ½ä¼˜å…ˆçº§é¢„æ’åº

#### 4. å†…å­˜ç®¡ç†
```kotlin
class SkillRanker : CleanableUp {
    override fun cleanup() {
        batches.clear()
        // æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ•°æ®
    }
}
```

### ğŸ“Š æ€§èƒ½ç›‘æ§

#### å…³é”®æŒ‡æ ‡
- **æŠ€èƒ½åŒ¹é…æ—¶é—´**: < 100ms
- **å¥å­è§£ææ—¶é—´**: < 50ms  
- **å†…å­˜ä½¿ç”¨**: < 50MB (æŠ€èƒ½ç³»ç»Ÿ)
- **æŠ€èƒ½åŠ è½½æ—¶é—´**: < 200ms

#### æ—¥å¿—ç›‘æ§
```kotlin
Log.d(TAG, "ğŸ¯ å¼€å§‹æŠ€èƒ½åŒ¹é…è¯„ä¼°ï¼Œè¾“å…¥è¯­å¥: $utterances")
Log.d(TAG, "ğŸ“Š æŠ€èƒ½æ•°é‡ - High: ${highSkills.size}, Medium: ${mediumSkills.size}, Low: ${lowSkills.size}")
Log.d(TAG, "ğŸ† æœ€ä½³æŠ€èƒ½: ${bestSkill?.skill?.correspondingSkillInfo?.id} (${bestSkill?.score?.scoreIn01Range()})")
```

---

## æ€»ç»“

Dicioçš„æ„å›¾åˆ†æä¸å‘½ä»¤æ§åˆ¶ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ ¸å¿ƒæœºåˆ¶å®ç°äº†é«˜æ•ˆã€å‡†ç¡®çš„è¯­éŸ³å‘½ä»¤å¤„ç†ï¼š

### ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿
1. **åˆ†å±‚è¯„åˆ†**: ç¡®ä¿é«˜ä¼˜å…ˆçº§å‘½ä»¤ä¼˜å…ˆåŒ¹é…
2. **å¤šè¯­è¨€æ”¯æŒ**: çµæ´»çš„å¥å­æ¨¡å¼å®šä¹‰ç³»ç»Ÿ
3. **å¤šè½®å¯¹è¯**: åŸºäºæŠ€èƒ½æ ˆçš„ä¸Šä¸‹æ–‡ç®¡ç†
4. **å¯æ‰©å±•æ€§**: æ’ä»¶åŒ–çš„æŠ€èƒ½æ¶æ„
5. **æ€§èƒ½ä¼˜åŒ–**: ç¼–è¯‘æ—¶ä¼˜åŒ–å’Œè¿è¡Œæ—¶ç¼“å­˜

### ğŸ”„ å¤„ç†æµç¨‹æ€»ç»“
```
ASRè¾“å…¥ â†’ SkillEvaluator â†’ SkillRanker â†’ æŠ€èƒ½åŒ¹é… â†’ æŠ€èƒ½æ‰§è¡Œ â†’ TTSè¾“å‡º
    â†“           â†“              â†“           â†“           â†“           â†“
 å®æ—¶æ˜¾ç¤º   çŠ¶æ€ç®¡ç†      ä¸‰è½®è¯„åˆ†    å¥å­åŒ¹é…    ä¸šåŠ¡é€»è¾‘    è¯­éŸ³åé¦ˆ
```

### ğŸ“ˆ æ‰©å±•æ–¹å‘
- æ”¯æŒæ›´å¤šè‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯
- é›†æˆæœºå™¨å­¦ä¹ æ¨¡å‹è¿›è¡Œæ„å›¾åˆ†ç±»
- å¢å¼ºå¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡ç†è§£èƒ½åŠ›
- ä¼˜åŒ–è·¨è¯­è¨€æŠ€èƒ½å…±äº«æœºåˆ¶

è¿™å¥—ç³»ç»Ÿä¸ºDicioæä¾›äº†å¼ºå¤§è€Œçµæ´»çš„è¯­éŸ³å‘½ä»¤å¤„ç†èƒ½åŠ›ï¼Œæ”¯æŒä»ç®€å•çš„å•è½®æŸ¥è¯¢åˆ°å¤æ‚çš„å¤šè½®äº¤äº’åœºæ™¯ã€‚
