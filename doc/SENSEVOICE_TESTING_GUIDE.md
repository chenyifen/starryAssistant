# SenseVoice 测试指南

## 📱 测试前准备

### 1. 编译并安装
```bash
cd /Users/user/AndroidStudioProjects/dicio-android
./gradlew assembleNoModelsDebug
adb install -r app/build/outputs/apk/noModels/debug/app-noModels-debug.apk
```

### 2. 开启日志监控
```bash
# 完整日志
adb logcat -c && adb logcat | grep "SenseVoiceInputDevice"

# 或者只看关键日志
adb logcat -c && adb logcat | grep -E "(🔊|🎙️|🔄|✅|🎯|📊)"
```

---

## 🧪 基础功能测试

### 测试1: 正常语音输入 ⭐⭐⭐⭐⭐

**操作**:
1. 点击悬浮球
2. 等待录音提示
3. 说一句话："今天天气怎么样"
4. 等待识别完成

**预期日志**:
```
✅ 录制已启动
📊 音频数据#1: size=1600, max=..., min=..., avg=...
🔊 能量检测触发: RMS=... > threshold=0.003000
🎙️ 检测到语音开始
🔄 开始实时识别
✅ 识别完成: [识别结果]
🎯 开始最终识别
✅ 最终识别结果: [完整结果]
```

**成功标准**:
- ✅ 看到 "🔊 能量检测触发"
- ✅ 看到 "🎙️ 检测到语音开始"
- ✅ 看到实时识别结果
- ✅ 看到最终识别结果
- ✅ UI显示识别结果（不是"未能理解您的请求"）

---

### 测试2: 静音检测 ⭐⭐⭐⭐

**操作**:
1. 点击悬浮球
2. 说话后保持静音2-3秒
3. 观察是否自动结束

**预期行为**:
- 说话后2秒静音应自动停止录音
- 进行最终识别
- 显示结果

**预期日志**:
```
🎙️ 检测到语音开始
... [识别过程] ...
🔇 检测到静音超时
🎯 开始最终识别
```

---

### 测试3: 最大时长限制 ⭐⭐⭐

**操作**:
1. 点击悬浮球
2. 连续说话超过10秒
3. 观察是否在10秒时自动停止

**预期行为**:
- 10秒后自动停止录音
- 进行最终识别

**预期日志**:
```
⏰ 达到最大录制时间
🎯 开始最终识别
```

---

### 测试4: 能量阈值验证 ⭐⭐⭐⭐⭐

**操作**:
1. 点击悬浮球
2. 轻声说话（测试低音量）
3. 观察日志中的RMS值

**关键日志**:
```
🔊 音频能量: RMS=0.001234, 阈值=0.003000, 已检测=false  # 未触发
🔊 音频能量: RMS=0.004567, 阈值=0.003000, 已检测=false  # 即将触发
🔊 能量检测触发: RMS=0.005123 > threshold=0.003000     # 触发！
```

**分析**:
- 如果RMS始终 < 0.003，说明音量太低，需要：
  - 提高麦克风音量
  - 或降低阈值到 0.002 或 0.001
- 如果RMS > 0.003 但未触发，检查VAD逻辑

---

## 🔍 诊断问题

### 问题A: 仍然显示"未能理解您的请求"

**诊断步骤**:

1. **检查是否检测到语音**
   ```bash
   adb logcat | grep "🎙️ 检测到语音开始"
   ```
   - 如果**没有**这行日志 → 能量检测问题
   - 如果**有**这行日志 → 识别问题

2. **检查RMS值**
   ```bash
   adb logcat | grep "🔊 音频能量"
   ```
   - 查看RMS值是否 > 0.003
   - 如果都很小 → 麦克风音量问题或阈值需要更低

3. **检查音频数据**
   ```bash
   adb logcat | grep "📊 音频数据"
   ```
   - 查看 max, min, avg 是否都接近0
   - 如果都是0 → 麦克风权限或硬件问题

---

### 问题B: 误触发（没说话就开始识别）

**可能原因**:
- 环境噪音太大
- 阈值太低

**解决**:
- 提高阈值到 0.005 或 0.01
- 或实现自适应阈值

---

### 问题C: 识别结果为空

**检查**:
```bash
adb logcat | grep "⚠️ 缓冲区为空"
```

如果看到这行：
- 说明语音检测工作了，但bufferOffset为0
- 检查VAD处理逻辑

---

## 📊 关键日志指标

### 正常流程的日志模板
```
时间戳 - 🚀 启动语音识别
时间戳 - ✅ 识别器初始化状态: true
时间戳 - 🔄 开始录制音频
时间戳 - ✅ 录制已启动
时间戳 - 🔄 启动音频处理
时间戳 - 📊 音频数据#1: size=1600, max=0.0234, min=-0.0198, avg=0.000023
时间戳 - 📊 音频数据#2: size=1600, max=0.0421, min=-0.0398, avg=0.000156
时间戳 - 🔊 音频能量: RMS=0.005123, 阈值=0.003000, 已检测=false
时间戳 - 🔊 能量检测触发: RMS=0.008456 > threshold=0.003000
时间戳 - 🎙️ 检测到语音开始
时间戳 - 🔄 开始实时识别
时间戳 - ✅ 识别完成: 今天
时间戳 - 🔄 开始实时识别
时间戳 - ✅ 识别完成: 今天天气
时间戳 - 🔄 开始实时识别
时间戳 - ✅ 识别完成: 今天天气怎么样
时间戳 - 🔇 检测到静音超时
时间戳 - 🎯 开始最终识别
时间戳 - ✅ 最终识别结果: 今天天气怎么样
时间戳 - 📊 识别结果: 今天天气怎么样
时间戳 - 🏁 音频处理结束
时间戳 - ✅ AudioRecord已清理
```

---

## 🎯 阈值调整指南

### 如何确定合适的阈值

1. **收集RMS数据**
   - 在安静环境下点击录音，观察背景RMS
   - 正常说话时，观察语音RMS

2. **计算阈值**
   ```
   背景RMS: ~0.001
   语音RMS: ~0.005-0.05
   
   合适阈值 = 背景RMS * 2 ~ 3
   例如: 0.001 * 2.5 = 0.0025
   ```

3. **修改代码**
   在 `SenseVoiceInputDevice.kt` Line 493:
   ```kotlin
   val threshold = 0.003  // 调整这个值
   ```

### 阈值参考表

| 阈值 | 灵敏度 | 适用场景 |
|------|--------|----------|
| 0.001 | 极高 | 安静环境，低音量说话 |
| 0.003 | 高 | **推荐默认值** |
| 0.005 | 中 | 有少量背景噪音 |
| 0.01 | 低 | 嘈杂环境（但可能检测不到正常语音） |

---

## 🔧 快速调整工具

### 临时降低阈值（无需重新编译）

如果需要快速测试不同阈值，可以：

1. **方案A: 修改常量**
   ```kotlin
   // Line 493
   val threshold = 0.002  // 改这里
   ```

2. **方案B: 使用系统属性（需要代码修改）**
   ```kotlin
   val threshold = SystemProperties.get("debug.sensevoice.threshold", "0.003").toDouble()
   ```
   然后通过adb调整：
   ```bash
   adb shell setprop debug.sensevoice.threshold 0.002
   ```

---

## ✅ 测试完成清单

- [ ] 正常语音输入测试通过
- [ ] 静音检测正常工作
- [ ] 最大时长限制正常工作
- [ ] 能量阈值验证完成
- [ ] RMS值在合理范围内
- [ ] 识别结果正确
- [ ] 没有"未能理解您的请求"错误

---

## 📝 测试报告模板

```markdown
## 测试环境
- 设备型号: 
- Android版本: 
- 测试时间: 
- 环境噪音: 安静/一般/嘈杂

## 测试结果

### 测试1: 正常语音输入
- 状态: ✅ 通过 / ❌ 失败
- RMS值: 
- 识别结果: 
- 备注: 

### 测试2: 静音检测
- 状态: ✅ 通过 / ❌ 失败
- 备注: 

### 测试3: 最大时长限制
- 状态: ✅ 通过 / ❌ 失败
- 备注: 

## 问题记录
1. 
2. 

## 日志附件
[粘贴关键日志]
```

---

## 🆘 需要帮助时

提供以下信息：
1. 完整的 logcat 日志
2. 测试操作步骤
3. RMS值范围
4. 设备型号和Android版本
5. 环境描述（安静/嘈杂）

---

**测试愉快！** 🎉






